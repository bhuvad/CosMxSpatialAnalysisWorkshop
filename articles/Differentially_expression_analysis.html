<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Part III: Spatially-Aware Marker Gene Detection in Spatial Transcriptomics Data • CosMxSpatialAnalysisWorkshop</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Part III: Spatially-Aware Marker Gene Detection in Spatial Transcriptomics Data">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CosMxSpatialAnalysisWorkshop</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Differentially_expression_analysis.html">Part III: Spatially-Aware Marker Gene Detection in Spatial Transcriptomics Data</a>
    </li>
    <li>
      <a href="../articles/Part_II_PhiSpace.html">Part II: Identify cell states using PhiSpace</a>
    </li>
    <li>
      <a href="../articles/workflow_spatial_cosmx.html">Part I: Introduction to imaging-based spatial transcriptomics analysis (Bruker CosMx NSCLC)</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/bhuvad/CosMxSpatialAnalysisWorkshop">
    <span class="fa fa-github"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Part III: Spatially-Aware Marker Gene Detection
in Spatial Transcriptomics Data</h1>
                        <h4 data-toc-skip class="author">Melody Jin</h4>
            <address class="author_afil">
      Walter and Eliza Hall InstituteThe University of
Melbourne<br><a class="author_email" href="mailto:#"></a><a href="mailto:jin.m@wehi.edu.au" class="email">jin.m@wehi.edu.au</a>
      </address>
                  
            <h4 data-toc-skip class="date">2025-08-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bhuvad/CosMxSpatialAnalysisWorkshop/blob/main/vignettes/Differentially_expression_analysis.Rmd"><code>vignettes/Differentially_expression_analysis.Rmd</code></a></small>
      <div class="hidden name"><code>Differentially_expression_analysis.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Spatial transcriptomics is a revolutionary technology that allows us
to measure gene expression while preserving the spatial context of cells
within tissues. Unlike traditional bulk or single-cell RNA sequencing,
spatial transcriptomics provides crucial information about where genes
are expressed in relation to tissue architecture, cell types, and
neighboring cells. This workshop demonstrates how to use the
<code>jazzPanda</code> package for spatially-aware marker gene detection
in spatial transcriptomics data.</p>
<div class="section level3">
<h3 id="what-is-jazzpanda">What is jazzPanda?<a class="anchor" aria-label="anchor" href="#what-is-jazzpanda"></a>
</h3>
<p><code>jazzPanda</code> is a specialized R package designed
specifically for spatial transcriptomics analysis. It addresses a key
limitation of traditional marker gene detection methods: they often
ignore the spatial organization of gene expression within tissues. By
incorporating spatial coordinates into the analysis, jazzPanda can
identify genes that not only differ between cell types but also exhibit
specific spatial patterns that may be biologically meaningful.</p>
</div>
<div class="section level3">
<h3 id="key-features-of-jazzpanda">Key Features of jazzPanda<a class="anchor" aria-label="anchor" href="#key-features-of-jazzpanda"></a>
</h3>
<ul>
<li>
<strong>Spatial-aware analysis</strong><br>
jazzPanda’s core innovation is its ability to incorporate spatial
coordinates directly into marker gene detection. Instead of just
comparing gene expression between cell types, it analyzes how genes are
spatially distributed relative to cell type clusters. This approach can
reveal:
<ul>
<li>Genes that are enriched in specific spatial regions of a cell
type</li>
<li>Spatial gradients of gene expression within cell populations</li>
<li>Genes that mark boundaries between different tissue regions</li>
</ul>
</li>
<li>
<strong>Multiple analytical approaches</strong><br>
jazzPanda provides two complementary methods for marker detection:
<ul>
<li>
<strong>Correlation-based approach</strong>: Identifies genes whose
spatial expression patterns correlate with cluster distributions using
permutation testing for statistical significance.</li>
<li>
<strong>Linear modeling approach</strong>: Uses linear modelling to
find genes that best predict cluster membership while accounting for
spatial relationships.</li>
</ul>
</li>
<li>
<strong>Background correction</strong><br>
Spatial transcriptomics data often contains technical noise and
artifacts. jazzPanda addresses this by:
<ul>
<li>Using negative control probes to model background noise</li>
<li>Incorporating background correction into the statistical models</li>
<li>Improving the specificity of marker detection by accounting for
technical artifacts</li>
</ul>
</li>
<li>
<strong>Multi-sample support</strong><br>
Real biological studies often involve multiple samples or replicates.
jazzPanda can:
<ul>
<li>Analyze multiple samples simultaneously</li>
<li>Identify robust markers that are consistent across replicates</li>
<li>Account for sample-specific spatial variations</li>
<li>Provide more reliable marker gene identification</li>
</ul>
</li>
<li>
<strong>Flexible spatial binning</strong><br>
Different tissues and research questions require different spatial
scales of analysis. jazzPanda supports:
<ul>
<li>Square binning for regular tissue regions</li>
<li>Hexagonal binning for more natural cell arrangements</li>
<li>Customizable bin sizes to match tissue characteristics</li>
<li>Adaptive binning based on cell density</li>
</ul>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="workshop-overview">Workshop Overview<a class="anchor" aria-label="anchor" href="#workshop-overview"></a>
</h3>
<p>This comprehensive workshop will guide you through the complete
jazzPanda workflow, from data preparation to result interpretation. We
will:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Load and preprocess spatial transcriptomics data</strong> -
Learn how to prepare your data for jazzPanda analysis</li>
<li>
<strong>Perform spatial vector analysis</strong> - Understand how
jazzPanda creates spatial representations of gene expression and cell
types</li>
<li>
<strong>Detect marker genes using correlation-based methods</strong>
- Use permutation testing to identify spatially correlated genes</li>
<li>
<strong>Detect marker genes using linear modeling accounting for
background noise</strong> - Apply linear modeling while incorporating
signal correction based on negative control probes to account for
technical background.</li>
<li>
<strong>Compare results with traditional methods</strong> - See how
spatial-aware analysis differs from standard differential
expression</li>
<li>
<strong>Analyze multiple replicates</strong> - Learn to leverage
multiple samples for robust marker detection</li>
</ol>
</div>
<div class="section level3">
<h3 id="data-description">Data Description<a class="anchor" aria-label="anchor" href="#data-description"></a>
</h3>
<p>This workshop uses spatial transcriptomics data from lung tissue
samples (Lung5_Rep1 and Lung5_Rep3). The data has been preprocessed and
subset to specific regions of interest to focus the analysis. The
samples contain multiple cell types that have been clustered based on
their gene expression profiles, and we’ll use jazzPanda to identify
genes that exhibit spatial patterns correlated with these cell type
clusters.</p>
<blockquote>
<p><strong>Important Note</strong>: This analysis uses only a subset of
the full spatial transcriptomics dataset to demonstrate jazzPanda
functionality. The results shown here are for educational purposes and
demonstrate the potential of spatial transcriptomics analysis. For
biological insights, the complete dataset should be analyzed with
appropriate statistical power and biological validation.</p>
</blockquote>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set random seed for reproducibility</span></span>
<span><span class="va">seed_number</span> <span class="op">&lt;-</span> <span class="fl">899</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed_number</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define consistent ggplot theme for spatial plots</span></span>
<span><span class="va">defined_theme</span> <span class="op">&lt;-</span> <span class="fu">theme</span><span class="op">(</span></span>
<span>  strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  strip.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, colour <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>  axis.line <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  axis.text.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  axis.text.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  axis.ticks <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  axis.title.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  axis.title.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  legend.position <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>  panel.background <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  panel.border <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  panel.grid.major <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  plot.background <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Function to automatically determine hex bin size based on data density</span></span>
<span><span class="va">auto_hex_bin</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">target_points_per_bin</span> <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">k</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op">/</span> <span class="va">target_points_per_bin</span></span>
<span>  <span class="va">bins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">k</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">10</span>, <span class="va">bins</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="data-loading">Data Loading<a class="anchor" aria-label="anchor" href="#data-loading"></a>
</h2>
<p>For the workshop demonstration, we extracted selected spatial regions
from the processed datasets provided in the previous workshop.
Specifically, we selected a rectangular region from r1 spanning
coordinates approximately between x = 10,000–20,000 and y =
155,000–165,000, and a region from r3 spanning x = –3,400–10,000 and y =
–1,800–5,000.</p>
<p>In addition to the cells located within these regions, we also
included the corresponding transcript data that fall within these
spatial windows.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Bioconductor/ExperimentHub" class="external-link">ExperimentHub</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SubcellularSpatialData</span><span class="op">)</span></span>
<span><span class="va">eh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ExperimentHub/man/ExperimentHub-class.html" class="external-link">ExperimentHub</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/AnnotationHub/man/AnnotationHub-class.html" class="external-link">query</a></span><span class="op">(</span><span class="va">eh</span>, <span class="st">'SubcellularSpatialData'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tx_detections</span> <span class="op">&lt;-</span> <span class="va">eh</span><span class="op">[[</span><span class="st">'EH8232'</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">all_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"all_tissue_PhiSpace.rds"</span><span class="op">)</span></span>
<span><span class="co"># cluster information </span></span>
<span><span class="va">r1_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">spatialCoords</span><span class="op">(</span><span class="va">all_data</span><span class="op">$</span><span class="va">Lung5_Rep1</span><span class="op">)</span>,</span>
<span>                                    cell_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Lung5_Rep1_"</span>,<span class="va">all_data</span><span class="op">$</span><span class="va">Lung5_Rep1</span><span class="op">$</span><span class="va">cell_id</span><span class="op">)</span>,</span>
<span>                                    sample <span class="op">=</span> <span class="va">all_data</span><span class="op">$</span><span class="va">Lung5_Rep1</span><span class="op">$</span><span class="va">sample_id</span>,</span>
<span>                                    cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="va">all_data</span><span class="op">$</span><span class="va">Lung5_Rep1</span><span class="op">$</span><span class="va">multiSampClust</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r1_all</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">r1_all</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">r1_all</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">r1_all</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="va">r1_cells</span> <span class="op">&lt;-</span> <span class="va">r1_all</span><span class="op">[</span><span class="va">r1_all</span><span class="op">$</span><span class="va">x</span><span class="op">&gt;</span><span class="fl">10000</span> <span class="op">&amp;</span> <span class="va">r1_all</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;</span><span class="fl">20000</span> <span class="op">&amp;</span> <span class="va">r1_all</span><span class="op">$</span><span class="va">y</span> <span class="op">&gt;</span> <span class="fl">155000</span><span class="op">&amp;</span> <span class="va">r1_all</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;</span> <span class="fl">165000</span>,<span class="op">]</span></span>
<span></span>
<span><span class="va">r1_cells</span> <span class="op">&lt;-</span> <span class="va">r1_cells</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">r1_cells</span><span class="op">$</span><span class="va">cell_id</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># transcript level information</span></span>
<span><span class="va">sr_r1</span> <span class="op">&lt;-</span> <span class="va">tx_detections</span><span class="op">$</span><span class="va">x</span><span class="op">&gt;</span><span class="fl">10000</span> <span class="op">&amp;</span> <span class="va">tx_detections</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;</span><span class="fl">20000</span> <span class="op">&amp;</span> <span class="va">tx_detections</span><span class="op">$</span><span class="va">y</span> <span class="op">&gt;</span> <span class="fl">155000</span> <span class="op">&amp;</span> <span class="va">tx_detections</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;</span> <span class="fl">165000</span></span>
<span><span class="va">keep_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gene"</span>, <span class="st">"genetype"</span>, <span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r1_tx</span> <span class="op">&lt;-</span> <span class="va">tx_detections</span><span class="op">[</span><span class="va">tx_detections</span><span class="op">$</span><span class="va">sample_id</span> <span class="op">==</span> <span class="st">"Lung5_Rep1"</span> <span class="op">&amp;</span> <span class="va">sr_r1</span>, <span class="va">keep_cols</span> <span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">use_data</span><span class="op">(</span><span class="va">r1_tx</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r3_all</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">spatialCoords</span><span class="op">(</span><span class="va">all_data</span><span class="op">$</span><span class="va">Lung5_Rep3</span><span class="op">)</span>,</span>
<span>                                    cell_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Lung5_Rep3_"</span>, <span class="va">all_data</span><span class="op">$</span><span class="va">Lung5_Rep3</span><span class="op">$</span><span class="va">cell_id</span><span class="op">)</span>,</span>
<span>                                    sample <span class="op">=</span> <span class="va">all_data</span><span class="op">$</span><span class="va">Lung5_Rep3</span><span class="op">$</span><span class="va">sample_id</span>,</span>
<span>                                    cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="va">all_data</span><span class="op">$</span><span class="va">Lung5_Rep3</span><span class="op">$</span><span class="va">multiSampClust</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r3_all</span><span class="op">$</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">r3_all</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">r3_all</span><span class="op">$</span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">r3_all</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="va">r3_cells</span> <span class="op">=</span> <span class="va">r3_all</span><span class="op">[</span><span class="va">r3_all</span><span class="op">$</span><span class="va">x</span><span class="op">&gt;</span><span class="op">-</span><span class="fl">3400</span> <span class="op">&amp;</span> <span class="va">r3_all</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;</span><span class="fl">10000</span> <span class="op">&amp;</span> <span class="va">r3_all</span><span class="op">$</span><span class="va">y</span> <span class="op">&gt;</span> <span class="op">-</span><span class="fl">1800</span> <span class="op">&amp;</span> <span class="va">r3_all</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;</span> <span class="fl">5000</span>,<span class="op">]</span></span>
<span><span class="va">r3_cells</span> <span class="op">&lt;-</span> <span class="va">r3_cells</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">r3_cells</span><span class="op">$</span><span class="va">cell_id</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">sr_r3</span> <span class="op">=</span> <span class="va">tx_detections</span><span class="op">$</span><span class="va">x</span><span class="op">&gt;</span><span class="op">-</span><span class="fl">3400</span> <span class="op">&amp;</span> <span class="va">tx_detections</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;</span><span class="fl">10000</span> <span class="op">&amp;</span> <span class="va">tx_detections</span><span class="op">$</span><span class="va">y</span> <span class="op">&gt;</span> <span class="op">-</span><span class="fl">1800</span> <span class="op">&amp;</span> <span class="va">tx_detections</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;</span> <span class="fl">5000</span></span>
<span></span>
<span><span class="va">keep_cols</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gene"</span>, <span class="st">"genetype"</span>, <span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r3_tx</span> <span class="op">=</span> <span class="va">tx_detections</span><span class="op">[</span><span class="va">tx_detections</span><span class="op">$</span><span class="va">sample_id</span> <span class="op">==</span> <span class="st">"Lung5_Rep3"</span> <span class="op">&amp;</span><span class="va">sr_r3</span>, <span class="va">keep_cols</span> <span class="op">]</span></span>
<span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">use_data</span><span class="op">(</span><span class="va">r3_tx</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">r1_se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"Lung5_Rep1.rds"</span><span class="op">)</span></span>
<span><span class="va">r3_se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"Lung5_Rep3.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Subset the SpatialExperiment object to the selected region</span></span>
<span><span class="va">r1_sub_se</span> <span class="op">&lt;-</span> <span class="va">r1_se</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">r1_se</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">r1_cells</span><span class="op">$</span><span class="va">cell_id</span><span class="op">]</span></span>
<span><span class="co"># Match cluster info from r1_cells</span></span>
<span><span class="va">matched_clusters</span> <span class="op">&lt;-</span> <span class="va">r1_cells</span><span class="op">$</span><span class="va">cluster</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">r1_sub_se</span><span class="op">)</span>, <span class="va">r1_cells</span><span class="op">$</span><span class="va">cell_id</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co"># Add as a new column in colData</span></span>
<span><span class="fu">colData</span><span class="op">(</span><span class="va">r1_sub_se</span><span class="op">)</span><span class="op">$</span><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="va">matched_clusters</span></span>
<span> <span class="co"># c1   c2   c3   c4   c6   c7   c8   c9 </span></span>
<span> <span class="co"># 773   33  858 1129  861  564 2395  267 </span></span>
<span><span class="fu">colData</span><span class="op">(</span><span class="va">r1_sub_se</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">colData</span><span class="op">(</span><span class="va">r1_sub_se</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sample_id"</span>, <span class="st">"cell_id"</span>,<span class="st">"cluster"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#saveRDS(r1_sub_se,"Lung5_Rep1_selected_cells.Rds")</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">use_data</span><span class="op">(</span><span class="va">r1_sub_se</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Subset the SpatialExperiment object to the selected region</span></span>
<span><span class="va">r3_sub_se</span> <span class="op">&lt;-</span> <span class="va">r3_se</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">r3_se</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">r3_cells</span><span class="op">$</span><span class="va">cell_id</span><span class="op">]</span></span>
<span><span class="co"># Match cluster info from r3_cells</span></span>
<span><span class="va">matched_clusters</span> <span class="op">&lt;-</span> <span class="va">r3_cells</span><span class="op">$</span><span class="va">cluster</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">r3_sub_se</span><span class="op">)</span>, <span class="va">r3_cells</span><span class="op">$</span><span class="va">cell_id</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co"># Add as a new column in colData</span></span>
<span><span class="fu">colData</span><span class="op">(</span><span class="va">r3_sub_se</span><span class="op">)</span><span class="op">$</span><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="va">matched_clusters</span></span>
<span><span class="fu">colData</span><span class="op">(</span><span class="va">r3_sub_se</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">colData</span><span class="op">(</span><span class="va">r3_sub_se</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sample_id"</span>, <span class="st">"cell_id"</span>,<span class="st">"cluster"</span><span class="op">)</span><span class="op">]</span></span>
<span> <span class="co"># c1   c2   c3   c4   c6   c7   c8   c9 </span></span>
<span> <span class="co"># 773   33  858 1129  861  564 2395  267 </span></span>
<span><span class="co">#saveRDS(r3_sub_se,"Lung5_Rep3_selected_cells.Rds")</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">use_data</span><span class="op">(</span><span class="va">r3_sub_se</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="data-components-explained">Data Components Explained<a class="anchor" aria-label="anchor" href="#data-components-explained"></a>
</h4>
<div class="section level5">
<h5 id="spatialexperiment-objects-r1_sub_se-r3_sub_se">SpatialExperiment objects (<code>r1_sub_se</code>,
<code>r3_sub_se</code>)<a class="anchor" aria-label="anchor" href="#spatialexperiment-objects-r1_sub_se-r3_sub_se"></a>
</h5>
<ul>
<li>Contain the gene expression count matrix<br>
</li>
<li>Include spatial coordinates for each cell<br>
</li>
<li>Store cell metadata (cluster assignments, sample IDs)<br>
</li>
<li>Provide methods for spatial analysis</li>
</ul>
</div>
<div class="section level5">
<h5 id="transcript-level-data-r1_tx-r3_tx">Transcript-level data (<code>r1_tx</code>, <code>r3_tx</code>)<a class="anchor" aria-label="anchor" href="#transcript-level-data-r1_tx-r3_tx"></a>
</h5>
<ul>
<li>Individual transcript detections with coordinates<br>
</li>
<li>Used by jazzPanda for spatial vector creation<br>
</li>
<li>Contains gene names and transcript types<br>
</li>
<li>Essential for understanding spatial gene expression patterns</li>
</ul>
</div>
<div class="section level5">
<h5 id="cell-information-data-frames-r1_cells-r3_cells">Cell information data frames (<code>r1_cells</code>,
<code>r3_cells</code>)<a class="anchor" aria-label="anchor" href="#cell-information-data-frames-r1_cells-r3_cells"></a>
</h5>
<ul>
<li>Combine all cell metadata in a convenient format<br>
</li>
<li>Used for visualization and analysis<br>
</li>
<li>Include unique cell identifiers for tracking<br>
</li>
<li>Ready for jazzPanda cluster information input</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">r1_sub_se</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">r3_sub_se</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">r1_tx</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">r3_tx</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Create cell information data frames</span></span>
<span><span class="va">r1_cells</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>  <span class="fu">spatialCoords</span><span class="op">(</span><span class="va">r1_sub_se</span><span class="op">)</span>,</span>
<span>  cell_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Lung5_Rep1_"</span>, <span class="va">r1_sub_se</span><span class="op">$</span><span class="va">cell_id</span><span class="op">)</span>,</span>
<span>  sample <span class="op">=</span> <span class="va">r1_sub_se</span><span class="op">$</span><span class="va">sample_id</span>,</span>
<span>  cluster <span class="op">=</span> <span class="va">r1_sub_se</span><span class="op">$</span><span class="va">cluster</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r1_cells</span><span class="op">$</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">r1_cells</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">r1_cells</span><span class="op">$</span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">r1_cells</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r3_cells</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>  <span class="fu">spatialCoords</span><span class="op">(</span><span class="va">r3_sub_se</span><span class="op">)</span>,</span>
<span>  cell_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Lung5_Rep3_"</span>, <span class="va">r3_sub_se</span><span class="op">$</span><span class="va">cell_id</span><span class="op">)</span>,</span>
<span>  sample <span class="op">=</span> <span class="va">r3_sub_se</span><span class="op">$</span><span class="va">sample_id</span>,</span>
<span>  cluster <span class="op">=</span> <span class="va">r3_sub_se</span><span class="op">$</span><span class="va">cluster</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r3_cells</span><span class="op">$</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">r3_cells</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">r3_cells</span><span class="op">$</span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">r3_cells</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Lung5_Rep1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"**Lung5_Rep1 cell counts by cluster:**\n\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## **Lung5_Rep1 cell counts by cluster:**</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r1_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">r1_cells</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span></span>
<span><span class="va">max_name_len</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">r1_tab</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">r1_tab</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  - %-*s : %d\n"</span>, <span class="va">max_name_len</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">r1_tab</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">r1_tab</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">##   - c1 : 773</span></span>
<span><span class="co">##   - c2 : 33</span></span>
<span><span class="co">##   - c3 : 858</span></span>
<span><span class="co">##   - c4 : 1129</span></span>
<span><span class="co">##   - c6 : 861</span></span>
<span><span class="co">##   - c7 : 564</span></span>
<span><span class="co">##   - c8 : 2395</span></span>
<span><span class="co">##   - c9 : 267</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n**Lung5_Rep3 cell counts by cluster:**\n\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## **Lung5_Rep3 cell counts by cluster:**</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r3_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">r3_cells</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span></span>
<span><span class="va">max_name_len</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">r3_tab</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">r3_tab</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  - %-*s : %d\n"</span>, <span class="va">max_name_len</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">r3_tab</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">r3_tab</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">##   - c1 : 924</span></span>
<span><span class="co">##   - c2 : 32</span></span>
<span><span class="co">##   - c3 : 813</span></span>
<span><span class="co">##   - c4 : 700</span></span>
<span><span class="co">##   - c6 : 813</span></span>
<span><span class="co">##   - c7 : 530</span></span>
<span><span class="co">##   - c8 : 1688</span></span>
<span><span class="co">##   - c9 : 118</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># === Spatial Coverage Summary ===</span></span>
<span></span>
<span></span>
<span><span class="va">r1_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">r1_cells</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">r1_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">r1_cells</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">r3_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">r3_cells</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">r3_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">r3_cells</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n\n### Spatial Coverage Summary\n\n"</span>,</span>
<span>    <span class="st">"Sample       | X Range            | Y Range\n"</span>,</span>
<span>    <span class="st">"-------------|--------------------|-------------------\n"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Lung5_Rep1   | %7.1f – %-7.1f | %7.1f – %-7.1f\n"</span>, <span class="va">r1_x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">r1_x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">r1_y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">r1_y</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Lung5_Rep3   | %7.1f – %-7.1f | %7.1f – %-7.1f\n"</span>, <span class="va">r3_x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">r3_x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">r3_y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">r3_y</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ### Spatial Coverage Summary</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Sample       | X Range            | Y Range</span></span>
<span><span class="co">##  -------------|--------------------|-------------------</span></span>
<span><span class="co">##  Lung5_Rep1   | 10000.5 – 19997.4 | 155232.6 – 164999.5</span></span>
<span><span class="co">##  Lung5_Rep3   | -3393.8 – 9995.9  | -1797.9 – 4999.9</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="visualize-spatial-distribution-of-clusters">Visualize Spatial Distribution of Clusters<a class="anchor" aria-label="anchor" href="#visualize-spatial-distribution-of-clusters"></a>
</h3>
<p>Understanding the spatial organization of cell type clusters is
essential before marker gene detection. This visualization reveals
tissue architecture, identifies spatial patterns, validates cluster
assignments, and guides interpretation of subsequent analyses. The
spatial arrangement of cell types reflects functional relationships,
tissue boundaries, microenvironmental niches, and disease states, all of
which influence marker gene patterns.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Spatial distribution plot</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">r1_cells</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, colour <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_colour_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">cluster</span>, ncol <span class="op">=</span> <span class="fl">3</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Spatial Distribution of Clusters - Lung5_Rep1 subset"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"X coordinate"</span>, y <span class="op">=</span> <span class="st">"Y coordinate"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>        strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>        plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Differentially_expression_analysis_files/figure-html/spatial_clusters-1.png" width="3000"></p>
</div>
</div>
<div class="section level2">
<h2 id="spatial-vector-analysis-with-jazzpanda">Spatial Vector Analysis with jazzPanda<a class="anchor" aria-label="anchor" href="#spatial-vector-analysis-with-jazzpanda"></a>
</h2>
<div class="section level3">
<h3 id="understanding-jazzpandas-core-concept">Understanding jazzPanda’s Core Concept<a class="anchor" aria-label="anchor" href="#understanding-jazzpandas-core-concept"></a>
</h3>
<p>jazzPanda works by converting spatial transcriptomics data into
<strong>spatial vectors</strong> - mathematical representations that
capture how genes and cell types are distributed across tissue space.
This is fundamentally different from traditional differential expression
analysis, which ignores spatial information.</p>
<div class="section level4">
<h4 id="what-are-spatial-vectors">What are Spatial Vectors?<a class="anchor" aria-label="anchor" href="#what-are-spatial-vectors"></a>
</h4>
<p>Spatial vectors are created by:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Dividing tissue into spatial bins</strong> (like pixels in
an image)</li>
<li>
<strong>Counting transcripts per bin</strong> for each gene</li>
<li>
<strong>Counting cells per bin</strong> for each cluster</li>
<li>
<strong>Creating correlation matrices</strong> between gene and
cluster spatial patterns</li>
</ol>
<p>This approach allows jazzPanda to identify genes whose spatial
expression patterns correlate with the spatial distribution of specific
cell types.</p>
</div>
</div>
<div class="section level3">
<h3 id="generate-spatial-vectors">Generate Spatial Vectors<a class="anchor" aria-label="anchor" href="#generate-spatial-vectors"></a>
</h3>
<p>This section creates the fundamental data structure that jazzPanda
uses for spatial-aware marker gene detection. Spatial vectors convert
continuous spatial coordinates into discrete bins, allowing correlation
analysis between gene expression patterns and cell type
distributions.</p>
<p>KEY CONCEPTS:</p>
<ul>
<li>
<strong>Spatial binning</strong>: Divides tissue into regular grid
cells (like pixels)</li>
<li>
<strong>Gene vectors</strong>: Count of transcripts per bin for each
gene</li>
<li>
<strong>Cluster vectors</strong>: Count of cells per bin for each
cluster</li>
<li>
<strong>Correlation analysis</strong>: Measures spatial relationship
between genes and clusters</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ============================================================================</span></span>
<span><span class="co"># SPATIAL VECTOR GENERATION - CORE JAZZPANDA FUNCTIONALITY</span></span>
<span><span class="co"># ============================================================================</span></span>
<span></span>
<span><span class="co"># Define binning parameters</span></span>
<span><span class="co"># - More bins (100x100): Higher spatial resolution, more noise, longer computation</span></span>
<span><span class="co"># - Fewer bins (10x10): Lower resolution, more stable patterns, faster computation</span></span>
<span><span class="va">grid_length</span> <span class="op">&lt;-</span> <span class="fl">20</span>  <span class="co"># Size of spatial bins (20x20 pixels)</span></span>
<span></span>
<span></span>
<span><span class="co"># We only analyze actual genes, not control probes</span></span>
<span><span class="va">genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">r1_tx</span><span class="op">[</span><span class="va">r1_tx</span><span class="op">$</span><span class="va">genetype</span> <span class="op">==</span> <span class="st">"Gene"</span>, <span class="st">"gene"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">r1_tx</span><span class="op">$</span><span class="va">feature_name</span> <span class="op">&lt;-</span> <span class="va">r1_tx</span><span class="op">$</span><span class="va">gene</span></span>
<span></span>
<span><span class="co"># Extract negative control probe names for background correction</span></span>
<span><span class="co"># These will be used later to model technical noise and improve specificity</span></span>
<span><span class="va">nc_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">r1_tx</span><span class="op">[</span><span class="va">r1_tx</span><span class="op">$</span><span class="va">genetype</span> <span class="op">==</span> <span class="st">"NegPrb"</span>, <span class="st">"gene"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>  <span class="st">"Data preparation summary:\n"</span>,</span>
<span>  <span class="st">"Number of genes to analyze:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">genes</span><span class="op">)</span>, <span class="st">"\n"</span>,</span>
<span>  <span class="st">"Number of negative control probes:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nc_names</span><span class="op">)</span>, <span class="st">"\n"</span>,</span>
<span>  <span class="st">"Spatial bin size:"</span>, <span class="va">grid_length</span>, <span class="st">"x"</span>, <span class="va">grid_length</span>, <span class="st">"pixels\n"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Data preparation summary:</span></span>
<span><span class="co">##  Number of genes to analyze: 960 </span></span>
<span><span class="co">##  Number of negative control probes: 20 </span></span>
<span><span class="co">##  Spatial bin size: 20 x 20 pixels</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate spatial vectors for genes and clusters</span></span>
<span><span class="co"># This is the core jazzPanda function that performs spatial binning:</span></span>
<span><span class="co"># 1. Divides tissue into 20x20 square bins</span></span>
<span><span class="co"># 2. Counts transcripts per bin for each gene</span></span>
<span><span class="co"># 3. Counts cells per bin for each cluster  </span></span>
<span><span class="va">r1_sv</span> <span class="op">&lt;-</span> <span class="fu">get_vectors</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Lung5_Rep1"</span> <span class="op">=</span> <span class="va">r1_tx</span><span class="op">)</span>,</span>
<span>    sample_names <span class="op">=</span> <span class="st">"Lung5_Rep1"</span>,</span>
<span>    cluster_info <span class="op">=</span> <span class="va">r1_cells</span>,</span>
<span>    bin_type <span class="op">=</span> <span class="st">"square"</span>,  <span class="co"># Square bins for regular tissue regions</span></span>
<span>    bin_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">grid_length</span>, <span class="va">grid_length</span><span class="op">)</span>,  <span class="co"># 20x20 pixel bins</span></span>
<span>    test_genes <span class="op">=</span> <span class="va">genes</span>  <span class="co"># Only analyze actual genes</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate spatial vectors for genes (from transcripts) and clusters </span></span>
<span><span class="co"># use the cell location and count matrix to create gene vectors </span></span>
<span><span class="co"># This is useful when: Transcript coordinate data is not available</span></span>
<span></span>
<span><span class="co"># IMPORTANT: For perfect alignment, always take both `cluster_mt` and `gene_mt`</span></span>
<span><span class="co"># from the SAME `get_vectors()` call so they share the exact window/tiles and</span></span>
<span><span class="co"># bin ordering.</span></span>
<span><span class="co"># r1_sv_cm &lt;- get_vectors(</span></span>
<span><span class="co">#     x = r1_sub_se,</span></span>
<span><span class="co">#     sample_names = "Lung5_Rep1",</span></span>
<span><span class="co">#     cluster_info = r1_cells,</span></span>
<span><span class="co">#     bin_type = "square",  # Square bins for regular tissue regions</span></span>
<span><span class="co">#     bin_param = c(grid_length, grid_length),  # 20x20 pixel bins</span></span>
<span><span class="co">#     test_genes = genes,  # Only analyze actual genes</span></span>
<span><span class="co">#     use_cm=TRUE # # Use cell count matrix instead of transcript coordinates</span></span>
<span><span class="co"># )</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># ============================================================================</span></span>
<span><span class="co"># INTERPRETATION OF SPATIAL VECTOR DIMENSIONS</span></span>
<span><span class="co"># ============================================================================</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n=== SPATIAL VECTOR DIMENSIONS ===\n"</span>,</span>
<span>    <span class="st">"Gene matrix:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">r1_sv</span><span class="op">$</span><span class="va">gene_mt</span><span class="op">)</span>, <span class="st">"\n"</span>,</span>
<span>    <span class="st">"Cluster matrix:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">r1_sv</span><span class="op">$</span><span class="va">cluster_mt</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span>  <span class="co"># Clusters x spatial bins</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## === SPATIAL VECTOR DIMENSIONS ===</span></span>
<span><span class="co">##  Gene matrix: 400 960 </span></span>
<span><span class="co">##  Cluster matrix: 400 8</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># What these dimensions mean:</span></span>
<span><span class="co"># - Gene matrix: Each column = one gene, each row = one spatial tile</span></span>
<span><span class="co"># - Cluster matrix: Each column = one cluster, each row = one spatial tile</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n=== SPATIAL BINNING SUMMARY ===\n"</span>,</span>
<span>    <span class="st">"Total spatial tile created:"</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">r1_sv</span><span class="op">$</span><span class="va">gene_mt</span><span class="op">)</span>, <span class="st">"\n"</span>,</span>
<span>    <span class="st">"Average transcripts per tile:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">r1_sv</span><span class="op">$</span><span class="va">gene_mt</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,<span class="st">"\n"</span>,</span>
<span>    <span class="st">"Average cells per tile:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">r1_sv</span><span class="op">$</span><span class="va">cluster_mt</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## === SPATIAL BINNING SUMMARY ===</span></span>
<span><span class="co">##  Total spatial tile created: 400 </span></span>
<span><span class="co">##  Average transcripts per tile: 19.2 </span></span>
<span><span class="co">##  Average cells per tile: 2.1</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="cluster-cluster-correlation-analysis">Cluster-Cluster Correlation Analysis<a class="anchor" aria-label="anchor" href="#cluster-cluster-correlation-analysis"></a>
</h3>
<p>To better understand how different cell clusters are organized within
the tissue, we compute the spatial correlation between their binned
abundance profiles. This highlights whether specific clusters tend to
co-localize or occupy distinct spatial niches. A high positive
correlation suggests that two clusters frequently appear in the same
spatial regions, possibly indicating shared biological roles or
transitional cell states. Conversely, a strong negative correlation may
reflect spatial separation or compartmentalization.</p>
<p>If many clusters exhibit consistently high positive correlations,
this may indicate that the data has been overclustered—i.e., multiple
clusters are capturing the same underlying cell population. In such
cases, it may be helpful to revisit the clustering resolution.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ============================================================================</span></span>
<span><span class="co"># CLUSTER-CLUSTER SPATIAL CORRELATION ANALYSIS</span></span>
<span><span class="co"># ============================================================================</span></span>
<span></span>
<span><span class="co"># Define cluster order for consistent visualization</span></span>
<span><span class="va">cluster_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">7</span>, <span class="fl">8</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r1_sv</span><span class="op">$</span><span class="va">cluster_mt</span> <span class="op">&lt;-</span> <span class="va">r1_sv</span><span class="op">$</span><span class="va">cluster_mt</span><span class="op">[</span>, <span class="va">cluster_names</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Calculate pairwise correlations between clusters</span></span>
<span><span class="co"># This measures how similar the spatial distribution patterns are between clusters</span></span>
<span><span class="va">cor_cluster_mt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">r1_sv</span><span class="op">$</span><span class="va">cluster_mt</span>, <span class="va">r1_sv</span><span class="op">$</span><span class="va">cluster_mt</span>, method <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create color palette for correlation heatmap</span></span>
<span><span class="co"># Blue = negative correlation, Red = positive correlation, White = no correlation</span></span>
<span><span class="va">col</span> <span class="op">&lt;-</span> <span class="fu">grDevices</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#4477AA"</span>, <span class="st">"#77AADD"</span>, </span>
<span>                                     <span class="st">"#FFFFFF"</span>, <span class="st">"#EE9988"</span>, <span class="st">"#BB4444"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot correlation heatmap</span></span>
<span><span class="fu">corrplot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/corrplot/man/corrplot.html" class="external-link">corrplot</a></span><span class="op">(</span></span>
<span>    <span class="va">cor_cluster_mt</span>, </span>
<span>    method <span class="op">=</span> <span class="st">"color"</span>, </span>
<span>    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/col.html" class="external-link">col</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span>, </span>
<span>    diag <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    addCoef.col <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"upper"</span>,</span>
<span>    tl.col <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>    tl.srt <span class="op">=</span> <span class="fl">0</span>, </span>
<span>    mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span> ,</span>
<span>    number.cex <span class="op">=</span> <span class="fl">0.4</span>, </span>
<span>    tl.cex <span class="op">=</span> <span class="fl">0.6</span>,</span>
<span>    cex.main <span class="op">=</span> <span class="fl">0.6</span>,</span>
<span>    cl.cex<span class="op">=</span><span class="fl">0.5</span>,</span>
<span>    sig.level <span class="op">=</span> <span class="fl">0.05</span>, </span>
<span>    insig <span class="op">=</span> <span class="st">"blank"</span>, </span>
<span>    title <span class="op">=</span> <span class="st">"Cluster-Cluster Spatial Correlation"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="Differentially_expression_analysis_files/figure-html/cluster_correlation-1.png" width="1500">
The spatial correlation heatmap reveals how clusters co-localize or
segregate across the tissue. Notably, clusters c3 and c4 show a moderate
positive correlation (r = 0.39), suggesting they tend to occupy
overlapping spatial regions. This is consistent with the spatial plots,
where both clusters are enriched along the upper and right edges of the
section—potentially reflecting functionally related or spatially
adjacent cell types. In contrast, clusters c8 and c4 (r = -0.30) and c8
and c3 (r = -0.27) display negative correlations, indicating mutually
exclusive spatial patterns. This is visually supported by the spatial
map, where c8 forms a dense central structure, while c3 and c4 are more
peripherally distributed. Other cluster pairs, such as c1 and c8 or c6
and c8, also show weak negative correlations, reflecting spatial
separation.</p>
<p>Overall, the correlation structure suggests that most clusters occupy
distinct spatial domains, with only a few showing significant overlap.
This supports the current clustering resolution as appropriate—there is
no strong evidence of overclustering, which would typically manifest as
widespread high correlations between clusters. Instead, the results
point to a meaningful spatial partitioning of cell types, which can now
be further interpreted in the context of tissue architecture or marker
gene expression.</p>
</div>
<div class="section level3">
<h3 id="cluster-gene-correlation-analysis">Cluster-Gene Correlation Analysis<a class="anchor" aria-label="anchor" href="#cluster-gene-correlation-analysis"></a>
</h3>
<p>This analysis examines the spatial correlation between gene
expression patterns and cluster distributions.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ============================================================================</span></span>
<span><span class="co"># CLUSTER-GENE SPATIAL CORRELATION ANALYSIS</span></span>
<span><span class="co"># ============================================================================</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># This analysis identifies genes whose spatial expression patterns correlate</span></span>
<span><span class="co"># with the spatial distribution of specific cell type clusters. This is the</span></span>
<span><span class="co"># foundation of jazzPanda's spatial-aware marker gene detection.</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># KEY INSIGHTS:</span></span>
<span><span class="co"># - High positive correlation: Gene is enriched in regions where cluster is abundant</span></span>
<span><span class="co"># - High negative correlation: Gene is depleted in regions where cluster is abundant</span></span>
<span><span class="co"># - Low correlation: Gene expression is independent of cluster distribution</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># ============================================================================</span></span>
<span></span>
<span><span class="co"># Calculate correlations between clusters and selected genes</span></span>
<span><span class="co"># Each value represents the spatial correlation between a cluster and a gene</span></span>
<span><span class="va">selected_genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"IL7R"</span>, <span class="st">"COL4A2"</span>,<span class="st">"GPNMB"</span>, <span class="st">"CXCL8"</span>, <span class="st">"FN1"</span>, <span class="st">"TPM2"</span>, </span>
<span>                    <span class="st">"TM4SF1"</span>, <span class="st">"IGHG2"</span>, <span class="st">"CXCL10"</span>,<span class="st">"MMP12"</span><span class="op">)</span></span>
<span><span class="va">cor_gc_mt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">r1_sv</span><span class="op">$</span><span class="va">cluster_mt</span>, <span class="va">r1_sv</span><span class="op">$</span><span class="va">gene_mt</span><span class="op">[</span>,<span class="va">selected_genes</span><span class="op">]</span>,</span>
<span>                 method <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set outer and inner margins to keep things compact but clean</span></span>
<span><span class="co"># par(mar = c(1, 1, 3, 1))  # Bottom, Left, Top, Right</span></span>
<span></span>
<span><span class="fu">corrplot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/corrplot/man/corrplot.html" class="external-link">corrplot</a></span><span class="op">(</span></span>
<span>    <span class="va">cor_gc_mt</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"color"</span>,</span>
<span>    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/col.html" class="external-link">col</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span>,</span>
<span>    diag <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    addCoef.col <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"upper"</span>,</span>
<span>    tl.col <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>    tl.srt <span class="op">=</span> <span class="fl">45</span>,</span>
<span>    mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span>,</span>
<span>    number.cex <span class="op">=</span> <span class="fl">0.4</span>, </span>
<span>    tl.cex <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    cl.cex<span class="op">=</span><span class="fl">0.3</span>,</span>
<span>    sig.level <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    insig <span class="op">=</span> <span class="st">"blank"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Cluster-Gene Spatial Correlation"</span>,</span>
<span>    cex.main <span class="op">=</span> <span class="fl">0.7</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="Differentially_expression_analysis_files/figure-html/gene_cluster_correlation-1.png" width="1800"></p>
</div>
</div>
<div class="section level2">
<h2 id="marker-gene-detection-methods">Marker Gene Detection Methods<a class="anchor" aria-label="anchor" href="#marker-gene-detection-methods"></a>
</h2>
<div class="section level3">
<h3 id="method-1-correlation-based-approach">Method 1: Correlation-Based Approach<a class="anchor" aria-label="anchor" href="#method-1-correlation-based-approach"></a>
</h3>
<p>The correlation-based approach identifies genes whose spatial
expression patterns correlate significantly with cluster distributions.
We can use permutation testing to assess statistical significance.</p>
<div class="section level4">
<h4 id="perform-permutation-testing">Perform Permutation Testing<a class="anchor" aria-label="anchor" href="#perform-permutation-testing"></a>
</h4>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ============================================================================</span></span>
<span><span class="co"># PERMUTATION TESTING FOR SPATIAL CORRELATION SIGNIFICANCE</span></span>
<span><span class="co"># ============================================================================</span></span>
<span></span>
<span><span class="co"># Set seed for reproducible results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed_number</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Starting permutation testing...\n"</span>,</span>
<span>    <span class="st">"Number of permutations:"</span>, <span class="fl">1000</span>, <span class="st">"\n"</span>,</span>
<span>    <span class="st">"Number of genes tested:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">genes</span><span class="op">)</span>, <span class="st">"\n"</span>,</span>
<span>    <span class="st">"Number of clusters:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cluster_names</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Starting permutation testing...</span></span>
<span><span class="co">##  Number of permutations: 1000 </span></span>
<span><span class="co">##  Number of genes tested: 960 </span></span>
<span><span class="co">##  Number of clusters: 8</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Perform permutation testing for correlation-based marker detection</span></span>
<span><span class="co"># This is computationally intensive but provides robust statistical significance</span></span>
<span><span class="va">perm_p</span> <span class="op">&lt;-</span> <span class="fu">compute_permp</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Lung5_Rep1"</span> <span class="op">=</span> <span class="va">r1_tx</span><span class="op">)</span>,</span>
<span>  cluster_info <span class="op">=</span> <span class="va">r1_cells</span>, </span>
<span>  perm.size <span class="op">=</span> <span class="fl">1000</span>,  <span class="co"># Number of permutations (more = more robust but slower)</span></span>
<span>  bin_type <span class="op">=</span> <span class="st">"square"</span>,</span>
<span>  bin_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">grid_length</span>, <span class="va">grid_length</span><span class="op">)</span>,</span>
<span>  test_genes <span class="op">=</span> <span class="va">genes</span>,</span>
<span>  correlation_method <span class="op">=</span> <span class="st">"pearson"</span>, </span>
<span>  n_cores <span class="op">=</span> <span class="fl">1</span>,  <span class="co"># Increase for faster computation on multi-core systems</span></span>
<span>  correction_method <span class="op">=</span> <span class="st">"BH"</span>  <span class="co"># Benjamini-Hochberg correction for multiple testing</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract results</span></span>
<span><span class="va">obs_corr</span> <span class="op">&lt;-</span> <span class="fu">get_cor</span><span class="op">(</span><span class="va">perm_p</span><span class="op">)</span>  <span class="co"># Observed correlations</span></span>
<span><span class="va">perm_res</span> <span class="op">&lt;-</span> <span class="fu">get_perm_p</span><span class="op">(</span><span class="va">perm_p</span><span class="op">)</span>  <span class="co"># Permutation-adjusted p-values</span></span>
<span></span>
<span></span>
<span><span class="va">sig_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">perm_res</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Permutation testing completed.\n"</span>,</span>
<span>    <span class="st">"Number of significant gene-cluster pairs (FDR &lt; 0.05):\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Permutation testing completed.</span></span>
<span><span class="co">##  Number of significant gene-cluster pairs (FDR &lt; 0.05):</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">cluster_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  %s: %d\n"</span>, <span class="va">i</span>, <span class="va">sig_counts</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">##   c1: 142</span></span>
<span><span class="co">##   c2: 235</span></span>
<span><span class="co">##   c3: 23</span></span>
<span><span class="co">##   c4: 4</span></span>
<span><span class="co">##   c6: 73</span></span>
<span><span class="co">##   c7: 147</span></span>
<span><span class="co">##   c8: 428</span></span>
<span><span class="co">##   c9: 24</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="examine-results">Examine Results<a class="anchor" aria-label="anchor" href="#examine-results"></a>
</h4>
<p>This section analyzes the results of permutation testing to identify
the most promising spatial marker genes. We examine both correlation
strength and statistical significance to find genes with robust spatial
patterns.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ============================================================================</span></span>
<span><span class="co"># EXAMINATION OF PERMUTATION TESTING RESULTS</span></span>
<span><span class="co"># ============================================================================</span></span>
<span><span class="co"># CRITERIA FOR TOP MARKERS:</span></span>
<span><span class="co"># 1. High absolute correlation (|r| &gt; 0.7)</span></span>
<span><span class="co"># 2. Statistical significance (FDR &lt; 0.05)</span></span>
<span><span class="co"># ============================================================================</span></span>
<span></span>
<span><span class="co"># Display top correlations (regardless of significance)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"=== TOP 10 HIGHEST CORRELATIONS ===\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## === TOP 10 HIGHEST CORRELATIONS ===</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">top_cor_genes</span> <span class="op">&lt;-</span> <span class="va">obs_corr</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">obs_corr</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">max</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">top_cor_genes</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                c6         c1         c9        c8         c3         c4</span></span>
<span><span class="co">## TM4SF1 -0.2432548 -0.2336321 -0.1766833 0.9034871 -0.2773497 -0.3031047</span></span>
<span><span class="co">## EPCAM  -0.2296324 -0.2448973 -0.1736810 0.8975413 -0.2724329 -0.2970755</span></span>
<span><span class="co">## SOX9   -0.2365242 -0.2430123 -0.1772934 0.8956744 -0.2965354 -0.3064993</span></span>
<span><span class="co">## ITGA3  -0.1902673 -0.2180898 -0.1548862 0.8926416 -0.2685670 -0.2891194</span></span>
<span><span class="co">## CDH1   -0.2397114 -0.2222582 -0.1684981 0.8920764 -0.2706071 -0.2955870</span></span>
<span><span class="co">## ANXA2  -0.2112035 -0.2207079 -0.1741656 0.8807889 -0.2708132 -0.3003662</span></span>
<span><span class="co">## ERBB3  -0.2169592 -0.2176163 -0.1603566 0.8797060 -0.2748823 -0.3003702</span></span>
<span><span class="co">## KRT19  -0.2653662 -0.2505629 -0.1842400 0.8768583 -0.2967594 -0.3179596</span></span>
<span><span class="co">## DDR1   -0.2065897 -0.2201620 -0.1613842 0.8766686 -0.2814231 -0.3087055</span></span>
<span><span class="co">## RAC1   -0.1515776 -0.1501326 -0.1504121 0.8757741 -0.2405148 -0.2711468</span></span>
<span><span class="co">##               c7         c2</span></span>
<span><span class="co">## TM4SF1 0.2114204 0.06374892</span></span>
<span><span class="co">## EPCAM  0.2953843 0.09852599</span></span>
<span><span class="co">## SOX9   0.2318317 0.08008944</span></span>
<span><span class="co">## ITGA3  0.2609914 0.11630001</span></span>
<span><span class="co">## CDH1   0.2132824 0.09143473</span></span>
<span><span class="co">## ANXA2  0.2606081 0.10041457</span></span>
<span><span class="co">## ERBB3  0.2594336 0.09588257</span></span>
<span><span class="co">## KRT19  0.1826650 0.05166671</span></span>
<span><span class="co">## DDR1   0.3028729 0.10237260</span></span>
<span><span class="co">## RAC1   0.2530473 0.11553943</span></span></code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Display significant results (regardless of correlation strength)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n=== TOP 10 MOST SIGNIFICANT RESULTS ===\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## === TOP 10 MOST SIGNIFICANT RESULTS ===</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">min_pvals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">perm_res</span>, <span class="fl">1</span>, <span class="va">min</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">top_sig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">min_pvals</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">perm_res</span><span class="op">[</span><span class="va">top_sig</span>, <span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                 c6          c1          c9          c8 c3 c4          c7</span></span>
<span><span class="co">## CCL19  0.692307692 0.000999001 0.815184815 1.000000000  1  1 1.000000000</span></span>
<span><span class="co">## IGHG2  0.000999001 0.000999001 0.000999001 1.000000000  1  1 0.996003996</span></span>
<span><span class="co">## IER3   1.000000000 1.000000000 1.000000000 0.000999001  1  1 0.004995005</span></span>
<span><span class="co">## CD276  1.000000000 1.000000000 1.000000000 0.000999001  1  1 0.000999001</span></span>
<span><span class="co">## SAA1   1.000000000 1.000000000 1.000000000 0.000999001  1  1 0.989010989</span></span>
<span><span class="co">## TYK2   1.000000000 1.000000000 1.000000000 0.000999001  1  1 0.575424575</span></span>
<span><span class="co">## CSF2RA 1.000000000 0.000999001 1.000000000 1.000000000  1  1 1.000000000</span></span>
<span><span class="co">## MIF    1.000000000 1.000000000 1.000000000 0.000999001  1  1 0.049950050</span></span>
<span><span class="co">## COL9A1 1.000000000 1.000000000 1.000000000 0.000999001  1  1 0.529470529</span></span>
<span><span class="co">## CCR7   0.997002997 0.000999001 1.000000000 1.000000000  1  1 1.000000000</span></span>
<span><span class="co">##                 c2</span></span>
<span><span class="co">## CCL19  0.814185814</span></span>
<span><span class="co">## IGHG2  0.645354645</span></span>
<span><span class="co">## IER3   0.262737263</span></span>
<span><span class="co">## CD276  0.002997003</span></span>
<span><span class="co">## SAA1   0.344655345</span></span>
<span><span class="co">## TYK2   0.249750250</span></span>
<span><span class="co">## CSF2RA 0.337662338</span></span>
<span><span class="co">## MIF    0.142857143</span></span>
<span><span class="co">## COL9A1 0.110889111</span></span>
<span><span class="co">## CCR7   0.667332667</span></span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">top_genes_per_cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">perm_res</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pvals</span> <span class="op">&lt;-</span> <span class="va">perm_res</span><span class="op">[</span>, <span class="va">cluster</span><span class="op">]</span></span>
<span>  <span class="va">corrs</span> <span class="op">&lt;-</span> <span class="va">obs_corr</span><span class="op">[</span>, <span class="va">cluster</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Combine and sort</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    gene <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">perm_res</span><span class="op">)</span>,</span>
<span>    pval <span class="op">=</span> <span class="va">pvals</span>,</span>
<span>    corr <span class="op">=</span> <span class="va">corrs</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">pval</span><span class="op">)</span>, <span class="op">]</span>  <span class="co"># remove NA</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">pval</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">corr</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span>  <span class="co"># first by pval, then by abs(corr)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">gene</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">top_genes_per_cluster</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">perm_res</span><span class="op">)</span></span>
<span><span class="va">top_genes_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">top_genes_per_cluster</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">heatmap_matrix</span> <span class="op">&lt;-</span> <span class="va">obs_corr</span><span class="op">[</span><span class="va">top_genes_all</span>, <span class="op">]</span></span>
<span><span class="va">heatmap_matrix</span> <span class="op">&lt;-</span> <span class="va">heatmap_matrix</span><span class="op">[</span>, <span class="va">cluster_names</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="fu">pheatmap</span><span class="op">(</span></span>
<span>  <span class="va">heatmap_matrix</span>,</span>
<span>  cluster_rows <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  cluster_cols <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Top 10 Spatially Correlated Genes per Cluster"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="Differentially_expression_analysis_files/figure-html/permutation_results-1.png" width="3000"></p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ============================================================================</span></span>
<span><span class="co"># INTEGRATED ANALYSIS: HIGH CORRELATION + SIGNIFICANCE</span></span>
<span><span class="co"># ============================================================================</span></span>
<span></span>
<span><span class="co"># Find genes that are both highly correlated and statistically significant</span></span>
<span><span class="va">high_cor_threshold</span> <span class="op">&lt;-</span> <span class="fl">0.7</span></span>
<span><span class="va">sig_threshold</span> <span class="op">&lt;-</span> <span class="fl">0.05</span></span>
<span></span>
<span><span class="co"># For each cluster, find top markers</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">cl</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">perm_res</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n--- Top markers for cluster"</span>, <span class="va">cl</span>, <span class="st">"---\n"</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Get correlations and p-values for this cluster</span></span>
<span>    <span class="va">cl_cors</span> <span class="op">&lt;-</span> <span class="va">obs_corr</span><span class="op">[</span>, <span class="va">cl</span><span class="op">]</span></span>
<span>    <span class="va">cl_pvals</span> <span class="op">&lt;-</span> <span class="va">perm_res</span><span class="op">[</span>, <span class="va">cl</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># Find genes meeting both criteria</span></span>
<span>    <span class="va">high_cor_sig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">cl_cors</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">high_cor_threshold</span> <span class="op">&amp;</span> <span class="va">cl_pvals</span> <span class="op">&lt;</span> <span class="va">sig_threshold</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">high_cor_sig</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># Sort by absolute correlation</span></span>
<span>        <span class="va">top_markers</span> <span class="op">&lt;-</span> <span class="va">high_cor_sig</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">cl_cors</span><span class="op">[</span><span class="va">high_cor_sig</span><span class="op">]</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span>        </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Genes with |r| &gt;"</span>, <span class="va">high_cor_threshold</span>, <span class="st">"and FDR &lt;"</span>, <span class="va">sig_threshold</span>, <span class="st">":\n"</span><span class="op">)</span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">top_markers</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">gene</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">top_markers</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>            <span class="va">cor_val</span> <span class="op">&lt;-</span> <span class="va">cl_cors</span><span class="op">[</span><span class="va">gene</span><span class="op">]</span></span>
<span>            <span class="va">p_val</span> <span class="op">&lt;-</span> <span class="va">cl_pvals</span><span class="op">[</span><span class="va">gene</span><span class="op">]</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  "</span>, <span class="va">gene</span>, <span class="st">": r ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cor_val</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">", FDR ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">p_val</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"No genes meet both criteria. Relaxing thresholds...\n"</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Relaxed criteria</span></span>
<span>        <span class="va">relaxed_cor</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span>        <span class="va">relaxed_sig</span> <span class="op">&lt;-</span> <span class="fl">0.05</span></span>
<span>        </span>
<span>        <span class="va">relaxed_markers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">cl_cors</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">relaxed_cor</span> <span class="op">&amp;</span> <span class="va">cl_pvals</span> <span class="op">&lt;</span> <span class="va">relaxed_sig</span><span class="op">)</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">relaxed_markers</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">top_relaxed</span> <span class="op">&lt;-</span> <span class="va">relaxed_markers</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">cl_cors</span><span class="op">[</span><span class="va">relaxed_markers</span><span class="op">]</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Genes with |r| &gt;"</span>, <span class="va">relaxed_cor</span>, <span class="st">"and FDR &lt;"</span>, <span class="va">relaxed_sig</span>, <span class="st">":\n"</span><span class="op">)</span></span>
<span>            <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">top_relaxed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>                <span class="va">gene</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">top_relaxed</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>                <span class="va">cor_val</span> <span class="op">&lt;-</span> <span class="va">cl_cors</span><span class="op">[</span><span class="va">gene</span><span class="op">]</span></span>
<span>                <span class="va">p_val</span> <span class="op">&lt;-</span> <span class="va">cl_pvals</span><span class="op">[</span><span class="va">gene</span><span class="op">]</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  "</span>, <span class="va">gene</span>, <span class="st">": r ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cor_val</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">", FDR ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">p_val</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>            <span class="op">}</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"No significant markers found even with relaxed criteria.\n"</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## --- Top markers for cluster c6 ---</span></span>
<span><span class="co">## No genes meet both criteria. Relaxing thresholds...</span></span>
<span><span class="co">## Genes with |r| &gt; 0.5 and FDR &lt; 0.05 :</span></span>
<span><span class="co">##    FN1 : r = 0.677 , FDR = 0.001 </span></span>
<span><span class="co">##    COL5A1 : r = 0.673 , FDR = 0.001 </span></span>
<span><span class="co">##    COL1A1 : r = 0.649 , FDR = 0.001 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## --- Top markers for cluster c1 ---</span></span>
<span><span class="co">## Genes with |r| &gt; 0.7 and FDR &lt; 0.05 :</span></span>
<span><span class="co">##    IL7R : r = 0.866 , FDR = 0.001 </span></span>
<span><span class="co">##    PTPRC : r = 0.85 , FDR = 0.001 </span></span>
<span><span class="co">##    CD37 : r = 0.835 , FDR = 0.001 </span></span>
<span><span class="co">##    FYN : r = 0.815 , FDR = 0.001 </span></span>
<span><span class="co">##    SELL : r = 0.812 , FDR = 0.001 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## --- Top markers for cluster c9 ---</span></span>
<span><span class="co">## No genes meet both criteria. Relaxing thresholds...</span></span>
<span><span class="co">## Genes with |r| &gt; 0.5 and FDR &lt; 0.05 :</span></span>
<span><span class="co">##    IGHG2 : r = 0.693 , FDR = 0.001 </span></span>
<span><span class="co">##    IGHG1 : r = 0.683 , FDR = 0.001 </span></span>
<span><span class="co">##    MZB1 : r = 0.674 , FDR = 0.001 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## --- Top markers for cluster c8 ---</span></span>
<span><span class="co">## Genes with |r| &gt; 0.7 and FDR &lt; 0.05 :</span></span>
<span><span class="co">##    TM4SF1 : r = 0.903 , FDR = 0.001 </span></span>
<span><span class="co">##    EPCAM : r = 0.898 , FDR = 0.001 </span></span>
<span><span class="co">##    SOX9 : r = 0.896 , FDR = 0.001 </span></span>
<span><span class="co">##    ITGA3 : r = 0.893 , FDR = 0.001 </span></span>
<span><span class="co">##    CDH1 : r = 0.892 , FDR = 0.001 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## --- Top markers for cluster c3 ---</span></span>
<span><span class="co">## Genes with |r| &gt; 0.7 and FDR &lt; 0.05 :</span></span>
<span><span class="co">##    GPNMB : r = 0.809 , FDR = 0.001 </span></span>
<span><span class="co">##    C1QB : r = 0.796 , FDR = 0.001 </span></span>
<span><span class="co">##    C1QA : r = 0.772 , FDR = 0.001 </span></span>
<span><span class="co">##    C1QC : r = 0.759 , FDR = 0.001 </span></span>
<span><span class="co">##    CD163 : r = 0.754 , FDR = 0.001 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## --- Top markers for cluster c4 ---</span></span>
<span><span class="co">## Genes with |r| &gt; 0.7 and FDR &lt; 0.05 :</span></span>
<span><span class="co">##    CXCL8 : r = 0.753 , FDR = 0.001 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## --- Top markers for cluster c7 ---</span></span>
<span><span class="co">## No genes meet both criteria. Relaxing thresholds...</span></span>
<span><span class="co">## Genes with |r| &gt; 0.5 and FDR &lt; 0.05 :</span></span>
<span><span class="co">##    TPM2 : r = 0.509 , FDR = 0.001 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## --- Top markers for cluster c2 ---</span></span>
<span><span class="co">## No genes meet both criteria. Relaxing thresholds...</span></span>
<span><span class="co">## No significant markers found even with relaxed criteria.</span></span></code></pre>
<p>Cluster c1 shows strong expression of classic lymphoid markers such
as IL7R, PTPRC, and SELL, suggesting a robust presence of T cells,
likely involved in immune surveillance or infiltration. Cluster c2 lacks
clear spatially enriched markers, which may reflect a heterogeneous or
transitional cell population, possibly at the interface of tumor and
stroma. Cluster c3 is enriched for genes like CD163 and C1QA/B/C,
indicating a population of tumor-associated macrophages, potentially
contributing to immunosuppressive or tissue-remodeling functions.</p>
<p>Cluster c4 is characterized by high spatial correlation with CXCL8, a
pro-inflammatory chemokine, hinting at an inflammatory microenvironment
that could influence tumor progression or immune cell recruitment. In
cluster c5, although markers weren’t explicitly listed, its position in
the annotation likely overlaps with the macrophage-rich c3 cluster or
represents a related myeloid subtype. Cluster c6 expresses high levels
of FN1 and collagens (COL1A1, COL5A1), pointing to a fibroblast-like or
CAF population involved in ECM remodeling and structural support.
Cluster c7, marked by TPM2, may correspond to contractile stromal cells,
such as smooth muscle-like or mesenchymal cells, possibly engaged in
mechanical remodeling of the tumor niche.</p>
<p>Cluster c8 shows a strong epithelial gene signature with markers like
EPCAM, CDH1, and SOX9, consistent with differentiated tumor cells,
potentially with stem-like features. Finally, cluster c9 stands out with
high expression of immunoglobulin genes (IGHG1, IGHG2) and MZB1,
indicative of plasma cells or plasmablasts, suggesting local antibody
production and humoral immune activity. Together, these clusters reflect
a spatially organized and biologically diverse landscape of tumor,
immune, and stromal elements, underscoring the complex cellular
interactions within the cancer microenvironment.</p>
</div>
<div class="section level4">
<h4 id="visualize-top-marker-genes">Visualize Top Marker Genes<a class="anchor" aria-label="anchor" href="#visualize-top-marker-genes"></a>
</h4>
<p>This section creates spatial plots showing the expression patterns of
the top marker genes identified by correaltion approach.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ============================================================================</span></span>
<span><span class="co"># SPATIAL VISUALIZATION OF TOP MARKER GENES</span></span>
<span><span class="co"># ============================================================================</span></span>
<span><span class="co"># - Left panel: Spatial distribution of the target cluster</span></span>
<span><span class="co"># - Right panels: Spatial expression patterns of top marker genes</span></span>
<span><span class="co"># - Color intensity: Transcript density (darker = more transcripts)</span></span>
<span><span class="co"># - Hexagonal bins: Smooth spatial representation of expression</span></span>
<span><span class="co"># ============================================================================</span></span>
<span><span class="va">permp_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">perm_p</span><span class="op">$</span><span class="va">perm.pval.adj</span><span class="op">)</span></span>
<span><span class="va">permp_df</span><span class="op">$</span><span class="va">gene</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">permp_df</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize top marker genes for each cluster</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">cl</span> <span class="kw">in</span> <span class="va">cluster_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Get significant genes for this cluster</span></span>
<span>  <span class="va">perm_sig</span> <span class="op">&lt;-</span> <span class="va">permp_df</span><span class="op">[</span><span class="va">permp_df</span><span class="op">[</span>, <span class="va">cl</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, <span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Define correlation cutoff (75th percentile)</span></span>
<span>  <span class="co"># obs_cutoff &lt;- quantile(obs_corr[, cl], 0.75)</span></span>
<span>  <span class="co"># cat("Correlation cutoff (75th percentile):", round(obs_cutoff, 3), "\n")</span></span>
<span>  </span>
<span>  <span class="va">obs_cutoff</span> <span class="op">&lt;-</span><span class="fl">0.5</span></span>
<span>  </span>
<span>  <span class="co"># Find genes that are both significant and have high correlation</span></span>
<span>  <span class="va">perm_cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">intersect</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">perm_res</span><span class="op">[</span><span class="va">perm_res</span><span class="op">[</span>, <span class="va">cl</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, <span class="op">]</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">obs_corr</span><span class="op">[</span><span class="va">obs_corr</span><span class="op">[</span>, <span class="va">cl</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">obs_cutoff</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">perm_cl</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Get top 3 genes by correlation value</span></span>
<span>    <span class="va">rounded_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">obs_corr</span><span class="op">[</span><span class="va">perm_cl</span>, <span class="va">cl</span><span class="op">]</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>gene <span class="op">=</span> <span class="va">perm_cl</span>, value <span class="op">=</span> <span class="va">rounded_val</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span> <span class="op">&lt;-</span> <span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="op">]</span></span>
<span>    <span class="va">inters_df</span> <span class="op">&lt;-</span> <span class="va">inters_df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="op">]</span></span>
<span>    <span class="va">inters_df</span><span class="op">$</span><span class="va">text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span>, <span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>, sep <span class="op">=</span> <span class="st">": "</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Prepare data for visualization</span></span>
<span>    <span class="va">curr_genes</span> <span class="op">&lt;-</span> <span class="va">r1_tx</span><span class="op">$</span><span class="va">feature_name</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span></span>
<span>    <span class="va">data_vis</span> <span class="op">&lt;-</span> <span class="va">r1_tx</span><span class="op">[</span><span class="va">curr_genes</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"feature_name"</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">data_vis</span><span class="op">$</span><span class="va">text</span> <span class="op">&lt;-</span> <span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">data_vis</span><span class="op">$</span><span class="va">feature_name</span>, <span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span>, <span class="st">"text"</span><span class="op">]</span></span>
<span>    <span class="va">data_vis</span><span class="op">$</span><span class="va">text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">data_vis</span><span class="op">$</span><span class="va">text</span>, levels <span class="op">=</span> <span class="va">inters_df</span><span class="op">$</span><span class="va">text</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Create hex bin plot for gene expression</span></span>
<span>    <span class="va">gene_pt</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_vis</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>            <span class="fu">geom_hex</span><span class="op">(</span>bins <span class="op">=</span> <span class="fu">auto_hex_bin</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data_vis</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">text</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu">scale_y_reverse</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"plasma"</span>, trans <span class="op">=</span> <span class="st">"sqrt"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_colorbar</span><span class="op">(</span>height <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">5</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="va">defined_theme</span> <span class="op">+</span></span>
<span>      <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span>, legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Top marker genes for cluster"</span>, <span class="va">cl</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Create cluster plot</span></span>
<span>    <span class="va">cl_pt</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">r1_cells</span><span class="op">[</span><span class="va">r1_cells</span><span class="op">$</span><span class="va">cluster</span> <span class="op">==</span> <span class="va">cl</span>, <span class="op">]</span>,</span>
<span>                    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">cluster</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">scale_y_reverse</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="va">defined_theme</span> <span class="op">+</span></span>
<span>      <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Cluster"</span>, <span class="va">cl</span>, <span class="st">"spatial distribution"</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span></span>
<span>    <span class="co"># Add empty panels if fewer than 3 features to keep layout consistent</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">perm_cl</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">gene_pt</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">gene_pt</span> <span class="op">|</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>       <span class="fu">plot_layout</span><span class="op">(</span>widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">perm_cl</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">gene_pt</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">gene_pt</span> <span class="op">|</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">|</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">plot_layout</span><span class="op">(</span>widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> </span>
<span>    </span>
<span>    <span class="va">lyt</span> <span class="op">&lt;-</span> <span class="fu">wrap_plots</span><span class="op">(</span><span class="va">cl_pt</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|</span> <span class="va">gene_pt</span></span>
<span>    <span class="va">layout_design</span> <span class="op">&lt;-</span> <span class="va">lyt</span> <span class="op">+</span> <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">layout_design</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<p><img src="Differentially_expression_analysis_files/figure-html/permutation_visualization-1.png" width="4500"><img src="Differentially_expression_analysis_files/figure-html/permutation_visualization-2.png" width="4500"><img src="Differentially_expression_analysis_files/figure-html/permutation_visualization-3.png" width="4500"><img src="Differentially_expression_analysis_files/figure-html/permutation_visualization-4.png" width="4500"><img src="Differentially_expression_analysis_files/figure-html/permutation_visualization-5.png" width="4500"><img src="Differentially_expression_analysis_files/figure-html/permutation_visualization-6.png" width="4500"></p>
</div>
</div>
<div class="section level3">
<h3 id="method-2-linear-modeling-approach-with-background-correction">Method 2: Linear Modeling Approach with Background Correction<a class="anchor" aria-label="anchor" href="#method-2-linear-modeling-approach-with-background-correction"></a>
</h3>
<p>The linear modeling approach uses Linear modelling to identify genes
that best predict cluster membership while accounting for background
noise using negative control probes.</p>
<div class="section level4">
<h4 id="prepare-background-data">Prepare Background Data<a class="anchor" aria-label="anchor" href="#prepare-background-data"></a>
</h4>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract negative control probe data</span></span>
<span><span class="va">r1_nc_tx</span> <span class="op">=</span> <span class="va">r1_tx</span><span class="op">[</span><span class="va">r1_tx</span><span class="op">$</span><span class="va">gene</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">nc_names</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Visualize spatial distribution of negative control probes</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">r1_nc_tx</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">feature_name</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_reverse</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">defined_theme</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Spatial Distribution of Negative Control Probes"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Differentially_expression_analysis_files/figure-html/background_preparation-1.png" width="4500"></p>
<p><strong>Note</strong>: Negative control probes should show random
spatial distribution. If they show spatial patterns, this may indicate
technical artifacts that need to be addressed.</p>
</div>
<div class="section level4">
<h4 id="create-background-vectors">Create Background Vectors<a class="anchor" aria-label="anchor" href="#create-background-vectors"></a>
</h4>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create spatial vectors for negative control probes</span></span>
<span><span class="va">r1_nc_vectors</span> <span class="op">&lt;-</span> <span class="fu">create_genesets</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Lung5_Rep1"</span> <span class="op">=</span> <span class="va">r1_nc_tx</span><span class="op">)</span>,</span>
<span>  sample_names <span class="op">=</span> <span class="st">"Lung5_Rep1"</span>,</span>
<span>  name_lst <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>probe <span class="op">=</span> <span class="va">nc_names</span><span class="op">)</span>, </span>
<span>  bin_type <span class="op">=</span> <span class="st">"square"</span>,</span>
<span>  bin_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">grid_length</span>, <span class="va">grid_length</span><span class="op">)</span>, </span>
<span>  cluster_info <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Background vectors created with"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nc_names</span><span class="op">)</span>, <span class="st">"negative control probes\n"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">r1_nc_vectors</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Background vectors created with 20 negative control probes</span></span>
<span><span class="co">##  400 1</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="perform-linear-modelling">Perform Linear Modelling<a class="anchor" aria-label="anchor" href="#perform-linear-modelling"></a>
</h4>
<p>The linear modelling approach used here leverages LASSO-regularized
generalized linear models to identify spatially enriched marker genes
across tissue clusters. This framework supports multi-sample designs and
can incorporate background correction to account for spatial patterns
unrelated to cell identity.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ============================================================================</span></span>
<span><span class="co"># Linear modelling FOR SPATIAL MARKER GENE DETECTION</span></span>
<span><span class="co"># ============================================================================</span></span>
<span><span class="co"># Set seed for reproducible results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed_number</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">" Number of genes:"</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">r1_sv</span><span class="op">$</span><span class="va">gene_mt</span><span class="op">)</span>, <span class="st">"\n"</span>,</span>
<span>    <span class="st">"Number of clusters:"</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">r1_sv</span><span class="op">$</span><span class="va">cluster_mt</span><span class="op">)</span>, <span class="st">"\n"</span>,</span>
<span>    <span class="st">"Number of spatial bins:"</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">r1_sv</span><span class="op">$</span><span class="va">gene_mt</span><span class="op">)</span>, <span class="st">"\n"</span>,</span>
<span>    <span class="st">"Background correction:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">r1_nc_vectors</span><span class="op">)</span>, </span>
<span>                                     <span class="st">"Enabled"</span>, <span class="st">"Disabled"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  Number of genes: 960 </span></span>
<span><span class="co">##  Number of clusters: 8 </span></span>
<span><span class="co">##  Number of spatial bins: 400 </span></span>
<span><span class="co">##  Background correction: Enabled</span></span></code></pre>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Perform linear model-based marker detection with background correction</span></span>
<span><span class="va">r1_lasso_lst</span> <span class="op">&lt;-</span> <span class="fu">lasso_markers</span><span class="op">(</span></span>
<span>  gene_mt <span class="op">=</span> <span class="va">r1_sv</span><span class="op">$</span><span class="va">gene_mt</span>,</span>
<span>  cluster_mt <span class="op">=</span> <span class="va">r1_sv</span><span class="op">$</span><span class="va">cluster_mt</span>,</span>
<span>  sample_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lung5_Rep1"</span><span class="op">)</span>,</span>
<span>  keep_positive <span class="op">=</span> <span class="cn">TRUE</span>,  <span class="co"># Only keep positive coefficients (enrichment)</span></span>
<span>  background <span class="op">=</span> <span class="va">r1_nc_vectors</span>  <span class="co"># Include background correction</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="examine-results-1">Examine Results<a class="anchor" aria-label="anchor" href="#examine-results-1"></a>
</h4>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Top result table </span></span>
<span><span class="co"># coef_cutoff = 0.2: Only keep genes with coefficient &gt; 0.2</span></span>
<span><span class="co"># This threshold can be adjusted based on your needs</span></span>
<span><span class="va">r1_top</span> <span class="op">&lt;-</span> <span class="fu">get_top_mg</span><span class="op">(</span><span class="va">r1_lasso_lst</span>, coef_cutoff <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Full result table </span></span>
<span><span class="va">r1_full</span> <span class="op">&lt;-</span> <span class="fu">get_full_mg</span><span class="op">(</span><span class="va">r1_lasso_lst</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Display top results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">r1_top</span><span class="op">[</span><span class="va">r1_top</span><span class="op">$</span><span class="va">top_cluster</span><span class="op">==</span><span class="st">"c8"</span>, <span class="op">]</span>,<span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              gene top_cluster  glm_coef   pearson max_gg_corr max_gc_corr</span></span>
<span><span class="co">## IER3         IER3          c8  6.733976 0.8583509   0.9335838   0.8583509</span></span>
<span><span class="co">## EPHA2       EPHA2          c8  2.897154 0.8266734   0.9497721   0.8266734</span></span>
<span><span class="co">## PSCA         PSCA          c8  1.224767 0.7427378   0.8208293   0.7427378</span></span>
<span><span class="co">## OLFM4       OLFM4          c8 28.657324 0.7807027   0.9018884   0.7807027</span></span>
<span><span class="co">## COL17A1   COL17A1          c8  1.932054 0.8622820   0.9581119   0.8622820</span></span>
<span><span class="co">## TNFRSF21 TNFRSF21          c8  1.355927 0.8560354   0.9446167   0.8560354</span></span>
<span><span class="co">## MMP1         MMP1          c8  6.186444 0.7098731   0.8683411   0.7098731</span></span>
<span><span class="co">## S100A6     S100A6          c8 35.709773 0.8628552   0.9831570   0.8628552</span></span>
<span><span class="co">## CDH1         CDH1          c8  2.815443 0.8920764   0.9714558   0.8920764</span></span>
<span><span class="co">## ITGB6       ITGB6          c8  3.070686 0.8091457   0.9241652   0.8091457</span></span></code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Display full results</span></span>
<span><span class="va">r1_full</span><span class="op">[</span><span class="va">r1_full</span><span class="op">$</span><span class="va">gene</span><span class="op">==</span><span class="st">"EPCAM"</span>, <span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##      gene cluster glm_coef      p_value   pearson max_gg_corr max_gc_corr</span></span>
<span><span class="co">## 815 EPCAM      c8 4.604450 3.494246e-52 0.8975413   0.9714558   0.8975413</span></span>
<span><span class="co">## 816 EPCAM   probe 1.280278 9.073677e-47 0.7072324   0.9714558   0.8975413</span></span></code></pre>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r1_full</span><span class="op">[</span><span class="va">r1_full</span><span class="op">$</span><span class="va">gene</span><span class="op">==</span><span class="st">"MZB1"</span>, <span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##      gene cluster  glm_coef      p_value   pearson max_gg_corr max_gc_corr</span></span>
<span><span class="co">## 1719 MZB1      c9 3.3399992 1.413055e-61 0.6738645    0.875899   0.6738645</span></span>
<span><span class="co">## 1720 MZB1      c1 0.6946244 1.180244e-17 0.3735805    0.875899   0.6738645</span></span>
<span><span class="co">## 1721 MZB1   probe 0.1177224 5.472379e-08 0.2375085    0.875899   0.6738645</span></span>
<span><span class="co">## 1722 MZB1      c6 0.3682316 6.766650e-04 0.2657707    0.875899   0.6738645</span></span></code></pre>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">cl</span> <span class="kw">in</span> <span class="va">cluster_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Subset to top genes for this cluster</span></span>
<span>  <span class="va">cluster_genes</span> <span class="op">&lt;-</span> <span class="va">r1_top</span><span class="op">[</span><span class="va">r1_top</span><span class="op">$</span><span class="va">top_cluster</span> <span class="op">==</span> <span class="va">cl</span>, <span class="op">]</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cluster_genes</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n=== Cluster:"</span>, <span class="va">cl</span>, <span class="st">"===\n"</span>,</span>
<span>        <span class="st">"  No marker genes found.\n"</span><span class="op">)</span></span>
<span>    <span class="kw">next</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Ensure numeric types</span></span>
<span>  <span class="va">cluster_genes</span><span class="op">$</span><span class="va">glm_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cluster_genes</span><span class="op">$</span><span class="va">glm_coef</span><span class="op">)</span></span>
<span>  <span class="va">cluster_genes</span><span class="op">$</span><span class="va">pearson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cluster_genes</span><span class="op">$</span><span class="va">pearson</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Sort by glm_coef</span></span>
<span>  <span class="va">cluster_genes</span> <span class="op">&lt;-</span> <span class="va">cluster_genes</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">cluster_genes</span><span class="op">$</span><span class="va">glm_coef</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Take top 3 genes</span></span>
<span>  <span class="va">top_genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cluster_genes</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Print nicely formatted output</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n=== Cluster:"</span>, <span class="va">cl</span>, <span class="st">"===\n"</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">top_genes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">gene</span> <span class="op">&lt;-</span> <span class="va">top_genes</span><span class="op">$</span><span class="va">gene</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="va">coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="va">top_genes</span><span class="op">$</span><span class="va">glm_coef</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="va">corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="va">top_genes</span><span class="op">$</span><span class="va">pearson</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  %d. %-10s | glm_coef: %-6s | corr: %-6s\n"</span>, <span class="va">i</span>, <span class="va">gene</span>, <span class="va">coef</span>, <span class="va">corr</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c1 ===</span></span>
<span><span class="co">##   1. CD74       | glm_coef: 18.6   | corr: 0.684 </span></span>
<span><span class="co">##   2. HLA-B      | glm_coef: 17.1   | corr: 0.724 </span></span>
<span><span class="co">##   3. HLA-C      | glm_coef: 14.4   | corr: 0.635 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c2 ===</span></span>
<span><span class="co">##    No marker genes found.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c3 ===</span></span>
<span><span class="co">##   1. PSAP       | glm_coef: 12     | corr: 0.559 </span></span>
<span><span class="co">##   2. C1QA       | glm_coef: 5.35   | corr: 0.772 </span></span>
<span><span class="co">##   3. C1QC       | glm_coef: 4.14   | corr: 0.759 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c4 ===</span></span>
<span><span class="co">##   1. CXCL8      | glm_coef: 7.2    | corr: 0.753 </span></span>
<span><span class="co">##   2. IL1R2      | glm_coef: 0.61   | corr: 0.266 </span></span>
<span><span class="co">##   3. CCL3L3     | glm_coef: 0.453  | corr: 0.503 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c6 ===</span></span>
<span><span class="co">##   1. COL1A1     | glm_coef: 19.1   | corr: 0.649 </span></span>
<span><span class="co">##   2. FN1        | glm_coef: 11     | corr: 0.677 </span></span>
<span><span class="co">##   3. BGN        | glm_coef: 6.99   | corr: 0.641 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c7 ===</span></span>
<span><span class="co">##   1. SERPINA1   | glm_coef: 5.5    | corr: 0.469 </span></span>
<span><span class="co">##   2. PDGFB      | glm_coef: 0.434  | corr: 0.448 </span></span>
<span><span class="co">##   3. WNT11      | glm_coef: 0.315  | corr: 0.323 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c8 ===</span></span>
<span><span class="co">##   1. S100A6     | glm_coef: 35.7   | corr: 0.863 </span></span>
<span><span class="co">##   2. OLFM4      | glm_coef: 28.7   | corr: 0.781 </span></span>
<span><span class="co">##   3. TM4SF1     | glm_coef: 13.1   | corr: 0.903 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c9 ===</span></span>
<span><span class="co">##   1. IGHG1      | glm_coef: 34.1   | corr: 0.683 </span></span>
<span><span class="co">##   2. IGKC       | glm_coef: 28     | corr: 0.6   </span></span>
<span><span class="co">##   3. IGHA1      | glm_coef: 26.2   | corr: 0.549</span></span></code></pre>
<p>Cluster c1 expresses CD74, HLA-B, and HLA-C, suggesting an
antigen-presenting population, likely composed of MHC class II-positive
immune cells such as dendritic cells or activated macrophages. The
presence of both class I and II HLA genes indicates active immune
engagement, potentially linked to antigen processing and T cell
interaction.</p>
<p>Cluster c3, marked by PSAP, C1QA, and GPNMB, again points to a
macrophage-rich compartment, likely involved in phagocytic and
immunomodulatory functions within the tumor. Similarly, cluster c4, with
strong expression of CXCL8, IL1R2, and CCL3L3, reflects a
pro-inflammatory myeloid population, potentially involved in leukocyte
recruitment and inflammatory cytokine signaling. Cluster c6 shows clear
stromal identity with markers such as COL1A1, FN1, and BGN, indicating a
fibroblast or cancer-associated fibroblast (CAF) phenotype actively
engaged in extracellular matrix organization.</p>
<p>Cluster c7 now reveals new markers: SERPINA1, PDGFB, and WNT11. This
combination may suggest a mesenchymal-like or signaling-active tumor
subpopulation, possibly involved in tissue remodeling, angiogenesis
(PDGFB), or Wnt-mediated developmental pathways (WNT11). Cluster c8
continues to show epithelial and cancer-associated markers such as
S100A6, OLFM4, and TM4SF1, reinforcing its identity as a tumor
epithelial compartment, potentially with proliferative or invasive
potential. Cluster c9 is again defined by immunoglobulin genes IGHG1,
IGKC, and IGHA1, strongly supporting the presence of plasma cells or
plasmablasts, indicating a local humoral immune response. Cluster c2
remains without clear marker genes, possibly representing a
transcriptionally ambiguous or under-characterized population requiring
further resolution.</p>
</div>
<div class="section level4">
<h4 id="visualize-top-marker-genes-from-linear-modelling">Visualize Top Marker Genes from Linear Modelling<a class="anchor" aria-label="anchor" href="#visualize-top-marker-genes-from-linear-modelling"></a>
</h4>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ============================================================================</span></span>
<span><span class="co"># SPATIAL VISUALIZATION OF TOP MARKER GENES</span></span>
<span><span class="co"># ============================================================================</span></span>
<span><span class="co"># - Left panel: Spatial distribution of the target cluster</span></span>
<span><span class="co"># - Right panels: Spatial expression patterns of top marker genes</span></span>
<span><span class="co"># - Color intensity: Transcript density (darker = more transcripts)</span></span>
<span><span class="co"># - Hexagonal bins: Smooth spatial representation of expression</span></span>
<span><span class="co"># ============================================================================</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">cl</span> <span class="kw">in</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">cluster_names</span>, <span class="st">"NoSig"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Get top genes for this cluster</span></span>
<span>    <span class="va">inters</span> <span class="op">&lt;-</span> <span class="va">r1_top</span><span class="op">[</span><span class="va">r1_top</span><span class="op">$</span><span class="va">top_cluster</span> <span class="op">==</span> <span class="va">cl</span>, <span class="st">"gene"</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">inters</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># Get coefficient values</span></span>
<span>        <span class="va">rounded_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">r1_top</span><span class="op">[</span><span class="va">inters</span>, <span class="st">"glm_coef"</span><span class="op">]</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>        <span class="va">inters_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>gene <span class="op">=</span> <span class="va">inters</span>, value <span class="op">=</span> <span class="va">rounded_val</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">inters_df</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span>        <span class="va">inters_df</span> <span class="op">&lt;-</span> <span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="op">]</span></span>
<span>        <span class="va">inters_df</span><span class="op">$</span><span class="va">text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span>, <span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>, sep <span class="op">=</span> <span class="st">": "</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Select top 3 genes</span></span>
<span>        <span class="va">inters_df</span> <span class="op">&lt;-</span> <span class="va">inters_df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span>        <span class="va">inters</span> <span class="op">&lt;-</span> <span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span></span>
<span>        </span>
<span>        <span class="co"># Prepare visualization data</span></span>
<span>        <span class="va">vis_r1</span> <span class="op">&lt;-</span> <span class="va">r1_tx</span><span class="op">[</span><span class="va">r1_tx</span><span class="op">$</span><span class="va">feature_name</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">inters</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"feature_name"</span><span class="op">)</span><span class="op">]</span></span>
<span>        <span class="va">vis_r1</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">vis_r1</span><span class="op">$</span><span class="va">feature_name</span>, <span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span>, <span class="st">"value"</span><span class="op">]</span></span>
<span>        <span class="va">vis_r1</span><span class="op">$</span><span class="va">text_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">vis_r1</span><span class="op">$</span><span class="va">feature_name</span>, <span class="va">vis_r1</span><span class="op">$</span><span class="va">value</span>, sep <span class="op">=</span> <span class="st">": "</span><span class="op">)</span></span>
<span>        <span class="va">vis_r1</span><span class="op">$</span><span class="va">text_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">vis_r1</span><span class="op">$</span><span class="va">text_label</span>, levels <span class="op">=</span> <span class="va">inters_df</span><span class="op">$</span><span class="va">text</span><span class="op">)</span></span>
<span>        <span class="va">vis_r1</span><span class="op">$</span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="st">"Lung5_Rep1"</span></span>
<span></span>
<span>        <span class="co"># Create hex bin plot</span></span>
<span>        <span class="va">gene_pt</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">vis_r1</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                <span class="fu">geom_hex</span><span class="op">(</span>bins <span class="op">=</span> <span class="fu">auto_hex_bin</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">vis_r1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">text_label</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"plasma"</span>, trans <span class="op">=</span> <span class="st">"sqrt"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_colorbar</span><span class="op">(</span>height <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">5</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="va">defined_theme</span> <span class="op">+</span></span>
<span>                <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span>, legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Top glm marker genes for cluster"</span>, <span class="va">cl</span><span class="op">)</span><span class="op">)</span></span>
<span>         </span>
<span>        <span class="co"># Create cluster plot</span></span>
<span>        <span class="va">cl_pt</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">r1_cells</span><span class="op">[</span><span class="va">r1_cells</span><span class="op">$</span><span class="va">cluster</span> <span class="op">==</span> <span class="va">cl</span>, <span class="op">]</span>,</span>
<span>                        <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">cluster</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="va">defined_theme</span> <span class="op">+</span></span>
<span>                <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Cluster"</span>, <span class="va">cl</span>, <span class="st">"spatial distribution"</span><span class="op">)</span><span class="op">)</span></span>
<span>        </span>
<span>        </span>
<span>        <span class="co"># Add empty panels if fewer than 3 features to keep layout consistent</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">inters</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">gene_pt</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">gene_pt</span> <span class="op">|</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>           <span class="fu">plot_layout</span><span class="op">(</span>widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">inters</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">gene_pt</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">gene_pt</span> <span class="op">|</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">|</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu">plot_layout</span><span class="op">(</span>widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span> </span>
<span>        </span>
<span>        <span class="va">lyt</span> <span class="op">&lt;-</span> <span class="fu">wrap_plots</span><span class="op">(</span><span class="va">cl_pt</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|</span> <span class="va">gene_pt</span></span>
<span>        <span class="va">layout_design</span> <span class="op">&lt;-</span> <span class="va">lyt</span> <span class="op">+</span> <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">layout_design</span><span class="op">)</span></span>
<span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Differentially_expression_analysis_files/figure-html/lasso_visualization-1.png" width="4500"><img src="Differentially_expression_analysis_files/figure-html/lasso_visualization-2.png" width="4500"><img src="Differentially_expression_analysis_files/figure-html/lasso_visualization-3.png" width="4500"><img src="Differentially_expression_analysis_files/figure-html/lasso_visualization-4.png" width="4500"><img src="Differentially_expression_analysis_files/figure-html/lasso_visualization-5.png" width="4500"><img src="Differentially_expression_analysis_files/figure-html/lasso_visualization-6.png" width="4500"><img src="Differentially_expression_analysis_files/figure-html/lasso_visualization-7.png" width="4500"></p>
</div>
</div>
<div class="section level3">
<h3 id="comparison-with-traditional-methods-findmarkers">Comparison with Traditional Methods: FindMarkers<a class="anchor" aria-label="anchor" href="#comparison-with-traditional-methods-findmarkers"></a>
</h3>
<p>Let’s compare jazzPanda results with traditional differential
expression analysis using Seurat’s FindMarkers function.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert to Seurat object for FindMarkers analysis)</span></span>
<span><span class="va">r1_seu</span> <span class="op">&lt;-</span> <span class="fu">as.Seurat</span><span class="op">(</span><span class="va">r1_sub_se</span>, data <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set cluster identities</span></span>
<span><span class="va">r1_seu</span><span class="op">$</span><span class="va">cluster</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">r1_seu</span><span class="op">$</span><span class="va">cluster</span>, levels <span class="op">=</span> <span class="va">cluster_names</span><span class="op">)</span></span>
<span><span class="fu">Idents</span><span class="op">(</span><span class="va">r1_seu</span><span class="op">)</span> <span class="op">=</span> <span class="va">r1_seu</span><span class="op">$</span><span class="va">cluster</span></span>
<span></span>
<span><span class="co"># Perform FindMarkers analysis</span></span>
<span><span class="co"># This is the traditional approach that ignores spatial information</span></span>
<span><span class="va">markers_fm</span> <span class="op">&lt;-</span> <span class="fu">FindAllMarkers</span><span class="op">(</span></span>
<span>  <span class="va">r1_seu</span>,</span>
<span>  only.pos <span class="op">=</span> <span class="cn">TRUE</span>,  <span class="co"># Only positive markers</span></span>
<span>  logfc.threshold <span class="op">=</span> <span class="fl">0</span>  <span class="co"># No minimum fold change threshold</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Organize results</span></span>
<span><span class="va">markers_fm</span><span class="op">$</span><span class="va">cluster</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">markers_fm</span><span class="op">$</span><span class="va">cluster</span>, levels <span class="op">=</span> <span class="va">cluster_names</span><span class="op">)</span></span>
<span><span class="va">markers_fm</span> <span class="op">=</span> <span class="va">markers_fm</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">markers_fm</span><span class="op">$</span><span class="va">cluster</span>,</span>
<span>                              <span class="va">markers_fm</span><span class="op">$</span><span class="va">p_val_adj</span>, <span class="op">-</span><span class="va">markers_fm</span><span class="op">$</span><span class="va">avg_log2FC</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Get top markers for each cluster</span></span>
<span><span class="va">split_markers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">markers_fm</span>, <span class="va">markers_fm</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span></span>
<span><span class="va">top3_markers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">split_markers</span>, <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">p_val_adj</span>, <span class="op">-</span><span class="va">df</span><span class="op">$</span><span class="va">avg_log2FC</span><span class="op">)</span>, <span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dot plots for comparison</span></span>
<span><span class="va">p1</span><span class="op">&lt;-</span><span class="fu">DotPlot</span><span class="op">(</span><span class="va">r1_seu</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">top3_markers</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_colour_gradient</span><span class="op">(</span>low <span class="op">=</span> <span class="st">"white"</span>, high <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Slightly smaller base font</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    plot.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>,  <span class="co"># Trim whitespace (top, right, bottom, left)</span></span>
<span>    axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span> hjust <span class="op">=</span> <span class="fl">0.5</span>, vjust <span class="op">=</span> <span class="fl">1</span>, size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>    axis.text.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>    panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>    legend.key.size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.3</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>,</span>
<span>    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">9</span>, margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>b <span class="op">=</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Top 5 marker genes by FindMarkers"</span>, x <span class="op">=</span> <span class="st">""</span>, y <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prepare jazzPanda-correlation results for comparison</span></span>
<span></span>
<span></span>
<span><span class="va">top3_perm_lst</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">cluster_names</span>, <span class="kw">function</span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pvals</span> <span class="op">&lt;-</span> <span class="va">perm_res</span><span class="op">[</span>, <span class="va">cluster</span><span class="op">]</span></span>
<span>  <span class="va">corrs</span> <span class="op">&lt;-</span> <span class="va">obs_corr</span><span class="op">[</span>, <span class="va">cluster</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Combine and sort</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    gene <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">perm_res</span><span class="op">)</span>,</span>
<span>    pval <span class="op">=</span> <span class="va">pvals</span>,</span>
<span>    corr <span class="op">=</span> <span class="va">corrs</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">pval</span><span class="op">)</span>, <span class="op">]</span>  <span class="co"># remove NA</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">pval</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">corr</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span>  <span class="co"># first by pval, then by abs(corr)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">gene</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">top3_perm_lst</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">perm_res</span><span class="op">)</span></span>
<span><span class="va">top3_perm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">top3_perm_lst</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">p2</span><span class="op">&lt;-</span><span class="fu">DotPlot</span><span class="op">(</span><span class="va">r1_seu</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">top3_perm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_colour_gradient</span><span class="op">(</span>low <span class="op">=</span> <span class="st">"white"</span>, high <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Slightly smaller base font</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    plot.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>,  <span class="co"># Trim whitespace (top, right, bottom, left)</span></span>
<span>    axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span> hjust <span class="op">=</span> <span class="fl">0.5</span>, vjust <span class="op">=</span> <span class="fl">1</span>, size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>    axis.text.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>    panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>    legend.key.size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.3</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>,</span>
<span>    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">9</span>, margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>b <span class="op">=</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Top 3 marker genes by jazzPanda-correlation"</span>, x <span class="op">=</span> <span class="st">""</span>, y <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># Prepare jazzPanda results for comparison</span></span>
<span><span class="va">jazzPanda_top_r1</span> <span class="op">=</span> <span class="va">r1_top</span><span class="op">[</span><span class="va">r1_top</span><span class="op">$</span><span class="va">top_cluster</span> <span class="op">!=</span> <span class="st">"NoSig"</span>, <span class="op">]</span></span>
<span><span class="va">jazzPanda_top_r1</span><span class="op">$</span><span class="va">top_cluster</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">jazzPanda_top_r1</span><span class="op">$</span><span class="va">top_cluster</span>, levels <span class="op">=</span> <span class="va">cluster_names</span><span class="op">)</span></span>
<span><span class="va">top3_jazzPanda</span> <span class="op">&lt;-</span> <span class="va">jazzPanda_top_r1</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">top_cluster</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">slice_max</span><span class="op">(</span>order_by <span class="op">=</span> <span class="va">glm_coef</span>, n <span class="op">=</span> <span class="fl">3</span>, with_ties <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span><span class="op">&lt;-</span><span class="fu">DotPlot</span><span class="op">(</span><span class="va">r1_seu</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">top3_jazzPanda</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_colour_gradient</span><span class="op">(</span>low <span class="op">=</span> <span class="st">"white"</span>, high <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Slightly smaller base font</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    plot.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>,  <span class="co"># Trim whitespace (top, right, bottom, left)</span></span>
<span>    axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">0</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>, vjust <span class="op">=</span> <span class="fl">1</span>, size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>    axis.text.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>    panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>    legend.key.size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.3</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>,</span>
<span>    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">9</span>, margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>b <span class="op">=</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Top 3 marker genes by jazzPanda-glm"</span>, x <span class="op">=</span> <span class="st">""</span>, y <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span> <span class="op">|</span> <span class="va">p3</span></span></code></pre></div>
<p><img src="Differentially_expression_analysis_files/figure-html/findmarkers_comparison-1.png" width="4500"></p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plt_lst</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">cl</span> <span class="kw">in</span> <span class="va">cluster_names</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>    <span class="va">findM_sig</span> <span class="op">=</span><span class="va">markers_fm</span><span class="op">[</span><span class="va">markers_fm</span><span class="op">$</span><span class="va">cluster</span><span class="op">==</span><span class="va">cl</span>,<span class="st">"gene"</span><span class="op">]</span></span>
<span>    <span class="va">lasso_cl</span><span class="op">=</span><span class="va">r1_top</span><span class="op">[</span><span class="va">r1_top</span><span class="op">$</span><span class="va">top_cluster</span><span class="op">==</span><span class="va">cl</span>, <span class="st">"gene"</span><span class="op">]</span></span>
<span>    <span class="va">obs_cutoff</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span>    <span class="va">perm_cl</span><span class="op">=</span><span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">perm_res</span><span class="op">[</span><span class="va">perm_res</span><span class="op">[</span>,<span class="va">cl</span><span class="op">]</span><span class="op">&lt;</span><span class="fl">0.05</span>,<span class="op">]</span><span class="op">)</span>,</span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">obs_corr</span><span class="op">[</span><span class="va">obs_corr</span><span class="op">[</span>, <span class="va">cl</span><span class="op">]</span><span class="op">&gt;</span><span class="va">obs_cutoff</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>    <span class="va">df_mt</span> <span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">FALSE</span>,nrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">r1_top</span><span class="op">)</span>,ncol<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">df_mt</span><span class="op">)</span> <span class="op">=</span><span class="va">r1_top</span><span class="op">$</span><span class="va">gene</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">df_mt</span><span class="op">)</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"jazzPanda-glm"</span>, <span class="st">"jazzPanda-correlation"</span>,</span>
<span>                      <span class="st">"Wilcoxon Rank Sum Test"</span><span class="op">)</span></span>
<span>    <span class="va">df_mt</span><span class="op">[</span><span class="va">findM_sig</span>,<span class="st">"Wilcoxon Rank Sum Test"</span><span class="op">]</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="va">df_mt</span><span class="op">[</span><span class="va">lasso_cl</span>,<span class="st">"jazzPanda-glm"</span><span class="op">]</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="va">df_mt</span><span class="op">[</span><span class="va">perm_cl</span>,<span class="st">"jazzPanda-correlation"</span><span class="op">]</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    </span>
<span>    <span class="va">df_mt</span><span class="op">$</span><span class="va">gene_name</span> <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">df_mt</span><span class="op">)</span></span>
<span>    <span class="va">p</span><span class="op">&lt;-</span><span class="fu">upset</span><span class="op">(</span><span class="va">df_mt</span>,</span>
<span>        intersect<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Wilcoxon Rank Sum Test"</span>, <span class="st">"jazzPanda-correlation"</span>,<span class="st">"jazzPanda-glm"</span><span class="op">)</span>,</span>
<span>        wrap<span class="op">=</span><span class="cn">TRUE</span>, keep_empty_groups<span class="op">=</span> <span class="cn">TRUE</span>, name<span class="op">=</span><span class="st">""</span>,</span>
<span>        themes<span class="op">=</span><span class="fu">theme_grey</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        stripes<span class="op">=</span><span class="fu">upset_stripes</span><span class="op">(</span>geom<span class="op">=</span><span class="fu">geom_segment</span><span class="op">(</span>size<span class="op">=</span><span class="fl">5</span><span class="op">)</span>,colors<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'grey95'</span>, <span class="st">'grey95'</span>, <span class="st">'grey95'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        sort_intersections_by <span class="op">=</span><span class="st">"cardinality"</span>, sort_sets<span class="op">=</span> <span class="cn">FALSE</span>,min_degree<span class="op">=</span><span class="fl">1</span>,</span>
<span>        set_sizes<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>        sort_intersections<span class="op">=</span> <span class="st">"descending"</span>, warn_when_converting<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>        warn_when_dropping_groups<span class="op">=</span><span class="cn">TRUE</span>,encode_sets<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>        matrix<span class="op">=</span><span class="op">(</span><span class="fu">intersection_matrix</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>                  <span class="fu">theme</span><span class="op">(</span>axis.text.x<span class="op">=</span><span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>                        panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill<span class="op">=</span><span class="st">"NA"</span><span class="op">)</span>,</span>
<span>                      axis.ticks <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>                      axis.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        base_annotations<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">'Intersection size'</span><span class="op">=</span><span class="op">(</span><span class="fu">intersection_size</span><span class="op">(</span>bar_number_threshold<span class="op">=</span><span class="fl">1</span>,color<span class="op">=</span><span class="st">'grey9'</span>,fill<span class="op">=</span><span class="st">'grey80'</span><span class="op">)</span><span class="op">+</span></span>
<span>                                                        <span class="fu">scale_y_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu">expansion</span><span class="op">(</span>mult <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.15</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>                                                    <span class="fu">theme</span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,axis.title.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>                                                          panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill<span class="op">=</span><span class="st">"NA"</span><span class="op">)</span>,</span>
<span>                                                          <span class="co">#plot.margin = margin(t = 10, r = 5, b = 5, l = 5),</span></span>
<span>                                                          panel.grid <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color<span class="op">=</span><span class="st">"grey90"</span><span class="op">)</span>,</span>
<span>                                                          axis.ticks.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              width_ratio<span class="op">=</span><span class="fl">0.5</span>, height_ratio<span class="op">=</span><span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span><span class="op">+</span></span>
<span>           <span class="fu">ggtitle</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">cl</span>,<span class="st">"cells"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">plt_lst</span><span class="op">[[</span><span class="va">cl</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">p</span></span>
<span><span class="op">}</span></span>
<span><span class="va">combined_plot</span> <span class="op">&lt;-</span> <span class="fu">wrap_plots</span><span class="op">(</span><span class="va">plt_lst</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined_plot</span> </span></code></pre></div>
<p><img src="Differentially_expression_analysis_files/figure-html/upset-compare-1.png" width="2400"></p>
</div>
</div>
<div class="section level2">
<h2 id="multi-sample-analysis">Multi-Sample Analysis<a class="anchor" aria-label="anchor" href="#multi-sample-analysis"></a>
</h2>
<div class="section level3">
<h3 id="prepare-multi-sample-data">Prepare Multi-Sample Data<a class="anchor" aria-label="anchor" href="#prepare-multi-sample-data"></a>
</h3>
<p>When multiple replicates are available, jazzPanda can leverage this
information to identify more robust marker genes.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Combine cell information from both replicates</span></span>
<span><span class="va">cluster_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">r1_cells</span>, <span class="va">r3_cells</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize spatial distribution across samples</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">cluster_info</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, colour <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_colour_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">sample</span>, ncol <span class="op">=</span> <span class="fl">2</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">guides</span><span class="op">(</span>colour <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fl">15</span>, size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Spatial Distribution by Sample and Cluster"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Differentially_expression_analysis_files/figure-html/multi_sample_preparation-1.png" width="3000"></p>
</div>
<div class="section level3">
<h3 id="multi-sample-spatial-vector-analysis">Multi-Sample Spatial Vector Analysis<a class="anchor" aria-label="anchor" href="#multi-sample-spatial-vector-analysis"></a>
</h3>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare transcript data for multi-sample analysis</span></span>
<span><span class="va">r3_tx</span><span class="op">$</span><span class="va">feature_name</span> <span class="op">&lt;-</span> <span class="va">r3_tx</span><span class="op">$</span><span class="va">gene</span></span>
<span></span>
<span><span class="co"># Generate spatial vectors for multiple samples</span></span>
<span><span class="va">multi_sample_sv</span> <span class="op">&lt;-</span> <span class="fu">get_vectors</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Lung5_Rep1 <span class="op">=</span> <span class="va">r1_tx</span>, Lung5_Rep3 <span class="op">=</span> <span class="va">r3_tx</span><span class="op">)</span>,</span>
<span>    sample_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lung5_Rep1"</span>, <span class="st">"Lung5_Rep3"</span><span class="op">)</span>,</span>
<span>    cluster_info <span class="op">=</span> <span class="va">cluster_info</span>, </span>
<span>    bin_type <span class="op">=</span> <span class="st">"square"</span>,</span>
<span>    bin_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">grid_length</span>, <span class="va">grid_length</span><span class="op">)</span>,</span>
<span>    test_genes <span class="op">=</span> <span class="va">genes</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prepare negative control data for multi-sample analysis</span></span>
<span><span class="va">r3_nc_tx</span> <span class="op">&lt;-</span> <span class="va">r3_tx</span><span class="op">[</span><span class="va">r3_tx</span><span class="op">$</span><span class="va">gene</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">nc_names</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">multi_sample_nc</span> <span class="op">&lt;-</span> <span class="fu">create_genesets</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Lung5_Rep1 <span class="op">=</span> <span class="va">r1_nc_tx</span>, Lung5_Rep3 <span class="op">=</span> <span class="va">r3_nc_tx</span><span class="op">)</span>,</span>
<span>  sample_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lung5_Rep1"</span>, <span class="st">"Lung5_Rep3"</span><span class="op">)</span>,</span>
<span>  name_lst <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>probe <span class="op">=</span> <span class="va">nc_names</span><span class="op">)</span>, </span>
<span>  bin_type <span class="op">=</span> <span class="st">"square"</span>,</span>
<span>  bin_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">grid_length</span>, <span class="va">grid_length</span><span class="op">)</span>, </span>
<span>  cluster_info <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Multi-sample spatial vectors created.\n"</span>,</span>
<span>    <span class="st">"Gene matrix dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">multi_sample_sv</span><span class="op">$</span><span class="va">gene_mt</span><span class="op">)</span>, <span class="st">"\n"</span>,</span>
<span>    <span class="st">"Cluster matrix dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">multi_sample_sv</span><span class="op">$</span><span class="va">cluster_mt</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Multi-sample spatial vectors created.</span></span>
<span><span class="co">##  Gene matrix dimensions: 800 960 </span></span>
<span><span class="co">##  Cluster matrix dimensions: 800 10</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="multi-sample-linear-modelling">Multi-Sample Linear modelling<a class="anchor" aria-label="anchor" href="#multi-sample-linear-modelling"></a>
</h3>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set seed for reproducible results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed_number</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Perform multi-sample lienar modelling</span></span>
<span><span class="va">multi_sample_lasso</span> <span class="op">&lt;-</span> <span class="fu">lasso_markers</span><span class="op">(</span>gene_mt <span class="op">=</span> <span class="va">multi_sample_sv</span><span class="op">$</span><span class="va">gene_mt</span>,</span>
<span>                                    cluster_mt <span class="op">=</span> <span class="va">multi_sample_sv</span><span class="op">$</span><span class="va">cluster_mt</span>,</span>
<span>                                sample_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lung5_Rep1"</span>, <span class="st">"Lung5_Rep3"</span><span class="op">)</span>,</span>
<span>                                keep_positive <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                                background <span class="op">=</span> <span class="va">multi_sample_nc</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract top results</span></span>
<span><span class="va">multi_sample_top</span> <span class="op">&lt;-</span> <span class="fu">get_top_mg</span><span class="op">(</span><span class="va">multi_sample_lasso</span>, coef_cutoff <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Extract full results</span></span>
<span><span class="va">multi_sample_full</span> <span class="op">&lt;-</span> <span class="fu">get_full_mg</span><span class="op">(</span><span class="va">multi_sample_lasso</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="examine-results-2">Examine Results<a class="anchor" aria-label="anchor" href="#examine-results-2"></a>
</h4>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Display top results</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">multi_sample_top</span><span class="op">[</span><span class="va">multi_sample_top</span><span class="op">$</span><span class="va">top_cluster</span><span class="op">==</span><span class="st">"c8"</span>, <span class="op">]</span>,<span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              gene top_cluster  glm_coef   pearson max_gg_corr max_gc_corr</span></span>
<span><span class="co">## IER3         IER3          c8 5.5968550 0.8485080   0.9257596   0.8485080</span></span>
<span><span class="co">## MIF           MIF          c8 5.3192798 0.8296015   0.9453560   0.8296015</span></span>
<span><span class="co">## KLF2         KLF2          c8 1.4376418 0.7046917   0.8351666   0.7672940</span></span>
<span><span class="co">## ADGRG6     ADGRG6          c8 0.2773574 0.7357393   0.8242252   0.7357393</span></span>
<span><span class="co">## EPHA2       EPHA2          c8 2.5458139 0.8280689   0.9457961   0.8280689</span></span>
<span><span class="co">## LGALS3     LGALS3          c8 1.8637312 0.7914608   0.8722060   0.7914608</span></span>
<span><span class="co">## TACSTD2   TACSTD2          c8 1.8534981 0.7921800   0.9354685   0.7921800</span></span>
<span><span class="co">## IRF3         IRF3          c8 1.3820246 0.6942337   0.8884235   0.7777010</span></span>
<span><span class="co">## PSCA         PSCA          c8 1.1857986 0.7515971   0.8334523   0.7515971</span></span>
<span><span class="co">## SERPINB5 SERPINB5          c8 0.7764836 0.8193537   0.9240545   0.8193537</span></span></code></pre>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">cl</span> <span class="kw">in</span> <span class="va">cluster_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Subset to top genes for this cluster</span></span>
<span>  <span class="va">cluster_genes</span> <span class="op">&lt;-</span> <span class="va">multi_sample_top</span><span class="op">[</span><span class="va">multi_sample_top</span><span class="op">$</span><span class="va">top_cluster</span> <span class="op">==</span> <span class="va">cl</span>, <span class="op">]</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cluster_genes</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n=== Cluster:"</span>, <span class="va">cl</span>, <span class="st">"===\n"</span>,</span>
<span>        <span class="st">"  No marker genes found.\n"</span><span class="op">)</span></span>
<span>    <span class="kw">next</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Ensure numeric types</span></span>
<span>  <span class="va">cluster_genes</span><span class="op">$</span><span class="va">glm_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cluster_genes</span><span class="op">$</span><span class="va">glm_coef</span><span class="op">)</span></span>
<span>  <span class="va">cluster_genes</span><span class="op">$</span><span class="va">pearson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cluster_genes</span><span class="op">$</span><span class="va">pearson</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Sort by glm_coef</span></span>
<span>  <span class="va">cluster_genes</span> <span class="op">&lt;-</span> <span class="va">cluster_genes</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">cluster_genes</span><span class="op">$</span><span class="va">glm_coef</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Take top 3 genes</span></span>
<span>  <span class="va">top_genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cluster_genes</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Print nicely formatted output</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n=== Cluster:"</span>, <span class="va">cl</span>, <span class="st">"===\n"</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">top_genes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">gene</span> <span class="op">&lt;-</span> <span class="va">top_genes</span><span class="op">$</span><span class="va">gene</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="va">coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="va">top_genes</span><span class="op">$</span><span class="va">glm_coef</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="va">corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="va">top_genes</span><span class="op">$</span><span class="va">pearson</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  %d. %-10s | glm_coef: %-6s | corr: %-6s\n"</span>, <span class="va">i</span>, <span class="va">gene</span>, <span class="va">coef</span>, <span class="va">corr</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c1 ===</span></span>
<span><span class="co">##   1. MALAT1     | glm_coef: 26.9   | corr: 0.418 </span></span>
<span><span class="co">##   2. CD74       | glm_coef: 18.4   | corr: 0.718 </span></span>
<span><span class="co">##   3. HLA-B      | glm_coef: 14.6   | corr: 0.718 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c2 ===</span></span>
<span><span class="co">##   1. COL12A1    | glm_coef: 1.67   | corr: 0.334 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c3 ===</span></span>
<span><span class="co">##   1. PSAP       | glm_coef: 11.4   | corr: 0.604 </span></span>
<span><span class="co">##   2. C1QA       | glm_coef: 5.07   | corr: 0.771 </span></span>
<span><span class="co">##   3. GPNMB      | glm_coef: 4.24   | corr: 0.8   </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c4 ===</span></span>
<span><span class="co">##   1. CXCL8      | glm_coef: 7.28   | corr: 0.729 </span></span>
<span><span class="co">##   2. IL1R2      | glm_coef: 0.546  | corr: 0.274 </span></span>
<span><span class="co">##   3. S100A8     | glm_coef: 0.308  | corr: 0.428 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c6 ===</span></span>
<span><span class="co">##   1. COL1A1     | glm_coef: 15.3   | corr: 0.622 </span></span>
<span><span class="co">##   2. FN1        | glm_coef: 9.29   | corr: 0.657 </span></span>
<span><span class="co">##   3. IGFBP7     | glm_coef: 8.7    | corr: 0.59  </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c7 ===</span></span>
<span><span class="co">##    No marker genes found.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c8 ===</span></span>
<span><span class="co">##   1. S100A6     | glm_coef: 31.6   | corr: 0.87  </span></span>
<span><span class="co">##   2. KRT19      | glm_coef: 27     | corr: 0.875 </span></span>
<span><span class="co">##   3. OLFM4      | glm_coef: 20.5   | corr: 0.766 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## === Cluster: c9 ===</span></span>
<span><span class="co">##   1. IGHG1      | glm_coef: 37     | corr: 0.672 </span></span>
<span><span class="co">##   2. IGKC       | glm_coef: 30.1   | corr: 0.592 </span></span>
<span><span class="co">##   3. IGHA1      | glm_coef: 27.9   | corr: 0.543</span></span></code></pre>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Display full results</span></span>
<span><span class="va">multi_sample_full</span><span class="op">[</span><span class="va">multi_sample_full</span><span class="op">$</span><span class="va">gene</span><span class="op">==</span><span class="st">"EPCAM"</span>, <span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##       gene cluster  glm_coef       p_value   pearson max_gg_corr max_gc_corr</span></span>
<span><span class="co">## 1018 EPCAM      c8 5.6240710 2.622303e-169 0.8929489   0.9673136   0.8929489</span></span>
<span><span class="co">## 1019 EPCAM   probe 0.7620053  9.618965e-43 0.6699822   0.9673136   0.8929489</span></span>
<span><span class="co">## 1020 EPCAM      c7 1.8136254  5.874387e-08 0.2709481   0.9673136   0.8929489</span></span>
<span><span class="co">## 1021 EPCAM      c2 3.6518637  3.942608e-02 0.1161284   0.9673136   0.8929489</span></span></code></pre>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multi_sample_full</span><span class="op">[</span><span class="va">multi_sample_full</span><span class="op">$</span><span class="va">gene</span><span class="op">==</span><span class="st">"MZB1"</span>, <span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##      gene cluster  glm_coef      p_value   pearson max_gg_corr max_gc_corr</span></span>
<span><span class="co">## 2149 MZB1      c9 3.0269883 3.290238e-91 0.6310573    0.868089   0.6310573</span></span>
<span><span class="co">## 2150 MZB1   probe 0.1528683 2.075327e-17 0.3016143    0.868089   0.6310573</span></span>
<span><span class="co">## 2151 MZB1      c1 0.3269219 4.336683e-11 0.2924043    0.868089   0.6310573</span></span>
<span><span class="co">## 2152 MZB1      c6 0.3129745 1.470690e-06 0.2600129    0.868089   0.6310573</span></span></code></pre>
<p>Cluster c1 is characterized by MALAT1, CD74, and HLA-B, suggesting a
lymphoid or antigen-presenting cell population. CD74 and HLA-B are
involved in MHC class II presentation, while MALAT1 is a long non-coding
RNA often expressed in immune cells and implicated in T cell activation
or regulation. Cluster c2, marked by COL12A1, likely represents a
stromal subset, possibly fibroblasts or ECM-producing cells, consistent
with its role in collagen cross-linking and matrix organization.</p>
<p>Cluster c3 shows clear expression of PSAP, C1QA, and GPNMB, aligning
with a macrophage or monocyte-derived population. These genes are
commonly found in tissue-resident or tumor-associated macrophages,
particularly those involved in phagocytosis and immune modulation.
Cluster c4 expresses pro-inflammatory markers CXCL8, IL1R2, and S100A8,
suggesting a myeloid-derived population actively participating in
inflammation or chemotaxis. Cluster c6, with high levels of COL1A1, FN1,
and IGFBP7, reflects a classic fibroblast-like phenotype, potentially
representing cancer-associated fibroblasts (CAFs) involved in
extracellular matrix remodeling and paracrine signaling.</p>
<p>Cluster c7 did not yield identifiable marker genes under current
thresholds, which could indicate a more transcriptionally quiescent
population or a mixed/ambiguous identity. Cluster c8 expresses
epithelial and tumor-associated markers including S100A6, KRT19, and
OLFM4, suggesting it corresponds to a tumor epithelial compartment,
possibly with proliferative or stem-like features. Lastly, cluster c9 is
defined by immunoglobulin genes IGHG1, IGKC, and IGHA1, indicative of
plasma cells or antibody-secreting plasmablasts, pointing to active
humoral immune engagement within the tumor microenvironment.</p>
</div>
<div class="section level4">
<h4 id="visualize-multi-sample-results">Visualize Multi-Sample Results<a class="anchor" aria-label="anchor" href="#visualize-multi-sample-results"></a>
</h4>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ============================================================================</span></span>
<span><span class="co"># SPATIAL VISUALIZATION OF TOP MARKER GENES</span></span>
<span><span class="co"># ============================================================================</span></span>
<span><span class="co"># - Left panel: Spatial distribution of the target cluster</span></span>
<span><span class="co"># - Right panels: Spatial expression patterns of top marker genes</span></span>
<span><span class="co"># - Color intensity: Transcript density (darker = more transcripts)</span></span>
<span><span class="co"># - Hexagonal bins: Smooth spatial representation of expression</span></span>
<span><span class="co"># ============================================================================</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">cl</span> <span class="kw">in</span> <span class="va">cluster_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Get top genes for this cluster</span></span>
<span>  <span class="va">inters</span> <span class="op">&lt;-</span> <span class="va">multi_sample_top</span><span class="op">[</span><span class="va">multi_sample_top</span><span class="op">$</span><span class="va">top_cluster</span> <span class="op">==</span> <span class="va">cl</span>, <span class="st">"gene"</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">inters</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Get coefficient values</span></span>
<span>    <span class="va">rounded_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">multi_sample_top</span><span class="op">[</span><span class="va">inters</span>, <span class="st">"glm_coef"</span><span class="op">]</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>gene <span class="op">=</span> <span class="va">inters</span>, value <span class="op">=</span> <span class="va">rounded_val</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span>    <span class="va">inters_df</span> <span class="op">&lt;-</span> <span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="op">]</span></span>
<span>    <span class="va">inters_df</span><span class="op">$</span><span class="va">text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span>, <span class="va">inters_df</span><span class="op">$</span><span class="va">value</span>, sep <span class="op">=</span> <span class="st">": "</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Select top 3 genes</span></span>
<span>    <span class="va">inters_df</span> <span class="op">&lt;-</span> <span class="va">inters_df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">inters_df</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span>    <span class="va">inters</span> <span class="op">&lt;-</span> <span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span></span>
<span>    </span>
<span>    <span class="co"># Prepare data for Lung5_Rep1</span></span>
<span>    <span class="va">iters_rep1</span> <span class="op">&lt;-</span> <span class="va">r1_tx</span><span class="op">$</span><span class="va">feature_name</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">inters</span></span>
<span>    <span class="va">vis_r1</span> <span class="op">&lt;-</span> <span class="va">r1_tx</span><span class="op">[</span><span class="va">iters_rep1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"feature_name"</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">vis_r1</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">vis_r1</span><span class="op">$</span><span class="va">feature_name</span>, <span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span>, <span class="st">"value"</span><span class="op">]</span></span>
<span>    <span class="va">vis_r1</span><span class="op">$</span><span class="va">text_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">vis_r1</span><span class="op">$</span><span class="va">feature_name</span>, <span class="va">vis_r1</span><span class="op">$</span><span class="va">value</span>, sep <span class="op">=</span> <span class="st">": "</span><span class="op">)</span></span>
<span>    <span class="va">vis_r1</span><span class="op">$</span><span class="va">text_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">vis_r1</span><span class="op">$</span><span class="va">text_label</span><span class="op">)</span></span>
<span>    <span class="va">vis_r1</span><span class="op">$</span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="st">"Lung5_Rep1"</span></span>
<span>    </span>
<span>    <span class="co"># Prepare data for Lung5_Rep3</span></span>
<span>    <span class="va">iters_rep3</span> <span class="op">&lt;-</span> <span class="va">r3_tx</span><span class="op">$</span><span class="va">feature_name</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">inters</span></span>
<span>    <span class="va">vis_r3</span> <span class="op">&lt;-</span> <span class="va">r3_tx</span><span class="op">[</span><span class="va">iters_rep3</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"feature_name"</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">vis_r3</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="va">inters_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">vis_r3</span><span class="op">$</span><span class="va">feature_name</span>, <span class="va">inters_df</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span>, <span class="st">"value"</span><span class="op">]</span></span>
<span>    <span class="va">vis_r3</span><span class="op">$</span><span class="va">text_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">vis_r3</span><span class="op">$</span><span class="va">feature_name</span>, <span class="va">vis_r3</span><span class="op">$</span><span class="va">value</span>, sep <span class="op">=</span> <span class="st">": "</span><span class="op">)</span></span>
<span>    <span class="va">vis_r3</span><span class="op">$</span><span class="va">text_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">vis_r3</span><span class="op">$</span><span class="va">text_label</span><span class="op">)</span></span>
<span>    <span class="va">vis_r3</span><span class="op">$</span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="st">"Lung5_Rep3"</span></span>
<span>    </span>
<span>    <span class="co"># Create plots for each sample</span></span>
<span>    <span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">vis_r1</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>            <span class="fu">geom_hex</span><span class="op">(</span>bins <span class="op">=</span> <span class="fu">auto_hex_bin</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">vis_r1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">text_label</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"plasma"</span>, trans <span class="op">=</span> <span class="st">"sqrt"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_colorbar</span><span class="op">(</span>height <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">5</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="va">defined_theme</span> <span class="op">+</span></span>
<span>      <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span>, legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> </span>
<span>         </span>
<span>    <span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">vis_r3</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu">geom_hex</span><span class="op">(</span>bins <span class="op">=</span> <span class="fu">auto_hex_bin</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">vis_r3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">text_label</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"plasma"</span>, trans <span class="op">=</span> <span class="st">"sqrt"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_colorbar</span><span class="op">(</span>height <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">5</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="va">defined_theme</span> <span class="op">+</span></span>
<span>      <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span>, legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> </span>
<span>     </span>
<span>    <span class="co"># Create cluster plot</span></span>
<span>    <span class="va">cl_pt</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">cluster_info</span><span class="op">[</span><span class="va">cluster_info</span><span class="op">$</span><span class="va">cluster</span> <span class="op">==</span> <span class="va">cl</span>, <span class="op">]</span>,</span>
<span>                    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">sample</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="va">defined_theme</span> <span class="op">+</span></span>
<span>      <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Cluster"</span>, <span class="va">cl</span>, <span class="st">"spatial distribution"</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Combine plots</span></span>
<span>    <span class="va">stacked_panel</span> <span class="op">=</span> <span class="op">(</span><span class="va">p1</span> <span class="op">/</span> <span class="va">p2</span><span class="op">)</span> </span>
<span>        </span>
<span>    <span class="co"># Add empty panels if fewer than 3 features to keep layout consistent</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">inters</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">stacked_panel</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">stacked_panel</span> <span class="op">|</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>           <span class="fu">plot_layout</span><span class="op">(</span>widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">inters</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">stacked_panel</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">stacked_panel</span> <span class="op">|</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span> <span class="op">|</span> <span class="fu">plot_spacer</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">plot_layout</span><span class="op">(</span>widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> </span>
<span></span>
<span>    <span class="va">lyt</span> <span class="op">&lt;-</span> <span class="fu">wrap_plots</span><span class="op">(</span><span class="va">cl_pt</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|</span> <span class="va">stacked_panel</span></span>
<span>    <span class="va">layout_design</span> <span class="op">&lt;-</span> <span class="va">lyt</span> <span class="op">+</span> <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">layout_design</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Differentially_expression_analysis_files/figure-html/multi_sample_visualization-1.png" width="3000"><img src="Differentially_expression_analysis_files/figure-html/multi_sample_visualization-2.png" width="3000"><img src="Differentially_expression_analysis_files/figure-html/multi_sample_visualization-3.png" width="3000"><img src="Differentially_expression_analysis_files/figure-html/multi_sample_visualization-4.png" width="3000"><img src="Differentially_expression_analysis_files/figure-html/multi_sample_visualization-5.png" width="3000"><img src="Differentially_expression_analysis_files/figure-html/multi_sample_visualization-6.png" width="3000"><img src="Differentially_expression_analysis_files/figure-html/multi_sample_visualization-7.png" width="3000"></p>
</div>
</div>
<div class="section level3">
<h3 id="summary-and-conclusions">Summary and Conclusions<a class="anchor" aria-label="anchor" href="#summary-and-conclusions"></a>
</h3>
<p>This workshop showcased how <strong>jazzPanda</strong> can be used to
detect spatially-informed marker genes in spatial transcriptomics data,
complementing standard tools like <strong>FindMarkers</strong>.</p>
<ul>
<li>
<strong>FindMarkers</strong>: Identifies differentially expressed
genes between clusters, but does not consider spatial layout.<br>
</li>
<li>
<strong>jazzPanda</strong>: Detects genes with expression patterns
that align with spatial structures and cluster boundaries.</li>
</ul>
<div class="section level4">
<h4 id="key-points">Key Points<a class="anchor" aria-label="anchor" href="#key-points"></a>
</h4>
<ol style="list-style-type: decimal">
<li><p><strong>Spatial resolution</strong><br>
jazzPanda highlights genes with spatial expression patterns, revealing
insights into tissue organization that standard non-spatial methods may
miss.</p></li>
<li>
<p><strong>Two analysis modes</strong></p>
<ul>
<li>The <strong>correlation approach</strong> is designed for
<strong>single-sample analysis</strong>, identifying genes spatially
correlated with clusters.<br>
</li>
<li>The <strong>linear modeling approach</strong> supports
<strong>multi-sample analysis</strong>, allowing detection of both
robust shared markers and <strong>sample-specific</strong> genes.</li>
</ul>
</li>
<li><p><strong>Background correction</strong><br>
Incorporating negative control probes improves marker specificity by
reducing background noise.</p></li>
<li><p><strong>Robustness across replicates</strong><br>
The linear modeling framework in jazzPanda enables consistent detection
of spatial markers across biological replicates.</p></li>
</ol>
<hr>
<p>While many tools are available for marker gene detection,
<strong>jazzPanda stands out by incorporating spatial context</strong>,
offering deeper biological insight and improving the robustness of
marker identification in complex tissue structures.</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.5.1 (2025-06-13)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">## Running under: Ubuntu 24.04.2 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">##  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">## [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: UTC</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] ComplexUpset_1.3.3                 dplyr_1.1.4                       </span></span>
<span><span class="co">##  [3] Seurat_5.3.0                       SeuratObject_5.1.0                </span></span>
<span><span class="co">##  [5] sp_2.2-0                           pheatmap_1.0.13                   </span></span>
<span><span class="co">##  [7] jazzPanda_1.0.1                    CosMxSpatialAnalysisWorkshop_1.0.0</span></span>
<span><span class="co">##  [9] corrplot_0.95                      SpatialExperiment_1.18.1          </span></span>
<span><span class="co">## [11] SingleCellExperiment_1.30.1        SummarizedExperiment_1.38.1       </span></span>
<span><span class="co">## [13] Biobase_2.68.0                     GenomicRanges_1.60.0              </span></span>
<span><span class="co">## [15] GenomeInfoDb_1.44.1                IRanges_2.42.0                    </span></span>
<span><span class="co">## [17] S4Vectors_0.46.0                   BiocGenerics_0.54.0               </span></span>
<span><span class="co">## [19] generics_0.1.4                     MatrixGenerics_1.20.0             </span></span>
<span><span class="co">## [21] matrixStats_1.5.0                  patchwork_1.3.1                   </span></span>
<span><span class="co">## [23] ggplot2_3.5.2                     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] RcppAnnoy_0.0.22        splines_4.5.1           later_1.4.2            </span></span>
<span><span class="co">##   [4] tibble_3.3.0            polyclip_1.10-7         hardhat_1.4.1          </span></span>
<span><span class="co">##   [7] pROC_1.19.0.1           rpart_4.1.24            fastDummies_1.7.5      </span></span>
<span><span class="co">##  [10] lifecycle_1.0.4         doParallel_1.0.17       globals_0.18.0         </span></span>
<span><span class="co">##  [13] lattice_0.22-7          MASS_7.3-65             magrittr_2.0.3         </span></span>
<span><span class="co">##  [16] limma_3.64.3            plotly_4.11.0           sass_0.4.10            </span></span>
<span><span class="co">##  [19] rmarkdown_2.29          jquerylib_0.1.4         yaml_2.3.10            </span></span>
<span><span class="co">##  [22] httpuv_1.6.16           sctransform_0.4.2       spam_2.11-1            </span></span>
<span><span class="co">##  [25] spatstat.sparse_3.1-0   reticulate_1.43.0       cowplot_1.2.0          </span></span>
<span><span class="co">##  [28] pbapply_1.7-4           RColorBrewer_1.1-3      lubridate_1.9.4        </span></span>
<span><span class="co">##  [31] abind_1.4-8             Rtsne_0.17              purrr_1.1.0            </span></span>
<span><span class="co">##  [34] BumpyMatrix_1.16.0      nnet_7.3-20             ipred_0.9-15           </span></span>
<span><span class="co">##  [37] lava_1.8.1              GenomeInfoDbData_1.2.14 ggrepel_0.9.6          </span></span>
<span><span class="co">##  [40] irlba_2.3.5.1           listenv_0.9.1           spatstat.utils_3.1-5   </span></span>
<span><span class="co">##  [43] goftest_1.2-3           RSpectra_0.16-2         spatstat.random_3.4-1  </span></span>
<span><span class="co">##  [46] fitdistrplus_1.2-4      parallelly_1.45.1       pkgdown_2.1.3          </span></span>
<span><span class="co">##  [49] codetools_0.2-20        DelayedArray_0.34.1     prettydoc_0.4.1        </span></span>
<span><span class="co">##  [52] tidyselect_1.2.1        shape_1.4.6.1           UCSC.utils_1.4.0       </span></span>
<span><span class="co">##  [55] farver_2.1.2            spatstat.explore_3.5-2  jsonlite_2.0.0         </span></span>
<span><span class="co">##  [58] caret_7.0-1             progressr_0.15.1        ggridges_0.5.6         </span></span>
<span><span class="co">##  [61] survival_3.8-3          iterators_1.0.14        systemfonts_1.2.3      </span></span>
<span><span class="co">##  [64] foreach_1.5.2           tools_4.5.1             ragg_1.4.0             </span></span>
<span><span class="co">##  [67] ica_1.0-3               Rcpp_1.1.0              glue_1.8.0             </span></span>
<span><span class="co">##  [70] prodlim_2025.04.28      gridExtra_2.3           SparseArray_1.8.1      </span></span>
<span><span class="co">##  [73] xfun_0.52               withr_3.0.2             fastmap_1.2.0          </span></span>
<span><span class="co">##  [76] digest_0.6.37           timechange_0.3.0        R6_2.6.1               </span></span>
<span><span class="co">##  [79] mime_0.13               colorspace_2.1-1        textshaping_1.0.1      </span></span>
<span><span class="co">##  [82] scattermore_1.2         tensor_1.5.1            spatstat.data_3.1-6    </span></span>
<span><span class="co">##  [85] hexbin_1.28.5           tidyr_1.3.1             data.table_1.17.8      </span></span>
<span><span class="co">##  [88] recipes_1.3.1           class_7.3-23            httr_1.4.7             </span></span>
<span><span class="co">##  [91] htmlwidgets_1.6.4       S4Arrays_1.8.1          uwot_0.2.3             </span></span>
<span><span class="co">##  [94] ModelMetrics_1.2.2.2    pkgconfig_2.0.3         gtable_0.3.6           </span></span>
<span><span class="co">##  [97] timeDate_4041.110       lmtest_0.9-40           XVector_0.48.0         </span></span>
<span><span class="co">## [100] htmltools_0.5.8.1       dotCall64_1.2           scales_1.4.0           </span></span>
<span><span class="co">## [103] png_0.1-8               gower_1.0.2             spatstat.univar_3.1-4  </span></span>
<span><span class="co">## [106] knitr_1.50              reshape2_1.4.4          rjson_0.2.23           </span></span>
<span><span class="co">## [109] nlme_3.1-168            cachem_1.1.0            zoo_1.8-14             </span></span>
<span><span class="co">## [112] stringr_1.5.1           KernSmooth_2.23-26      parallel_4.5.1         </span></span>
<span><span class="co">## [115] miniUI_0.1.2            desc_1.4.3              pillar_1.11.0          </span></span>
<span><span class="co">## [118] grid_4.5.1              vctrs_0.6.5             RANN_2.6.2             </span></span>
<span><span class="co">## [121] promises_1.3.3          xtable_1.8-4            cluster_2.1.8.1        </span></span>
<span><span class="co">## [124] evaluate_1.0.4          magick_2.8.7            cli_3.6.5              </span></span>
<span><span class="co">## [127] compiler_4.5.1          rlang_1.1.6             crayon_1.5.3           </span></span>
<span><span class="co">## [130] future.apply_1.20.0     labeling_0.4.3          plyr_1.8.9             </span></span>
<span><span class="co">## [133] fs_1.6.6                stringi_1.8.7           viridisLite_0.4.2      </span></span>
<span><span class="co">## [136] deldir_2.0-4            BiocParallel_1.42.1     lazyeval_0.2.2         </span></span>
<span><span class="co">## [139] spatstat.geom_3.5-0     glmnet_4.1-10           Matrix_1.7-3           </span></span>
<span><span class="co">## [142] RcppHNSW_0.6.0          future_1.67.0           statmod_1.5.0          </span></span>
<span><span class="co">## [145] shiny_1.11.1            ROCR_1.0-11             igraph_2.1.4           </span></span>
<span><span class="co">## [148] bslib_0.9.0</span></span></code></pre>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-R-rmarkdown" class="csl-entry">
Allaire, JJ, Yihui Xie, Christophe Dervieux, Jonathan McPherson, Javier
Luraschi, Kevin Ushey, Aron Atkins, et al. 2024. <em>Rmarkdown: Dynamic
Documents for r</em>. <a href="https://github.com/rstudio/rmarkdown" class="external-link">https://github.com/rstudio/rmarkdown</a>.
</div>
<div id="ref-R-prettydoc" class="csl-entry">
Qiu, Yixuan. 2021. <em>Prettydoc: Creating Pretty Documents from r
Markdown</em>. <a href="https://github.com/yixuan/prettydoc" class="external-link">https://github.com/yixuan/prettydoc</a>.
</div>
<div id="ref-R-ggplot2" class="csl-entry">
Wickham, Hadley, Winston Chang, Lionel Henry, Thomas Lin Pedersen,
Kohske Takahashi, Claus Wilke, Kara Woo, Hiroaki Yutani, Dewey
Dunnington, and Teun van den Brand. 2025. <em>Ggplot2: Create Elegant
Data Visualisations Using the Grammar of Graphics</em>. <a href="https://ggplot2.tidyverse.org" class="external-link">https://ggplot2.tidyverse.org</a>.
</div>
<div id="ref-R-knitr" class="csl-entry">
Xie, Yihui. 2025. <em>Knitr: A General-Purpose Package for Dynamic
Report Generation in r</em>. <a href="https://yihui.org/knitr/" class="external-link">https://yihui.org/knitr/</a>.
</div>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Dharmesh D. Bhuva, Jiadong Mao, Melody Jin, Chin Wee Tan.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
